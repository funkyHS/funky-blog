<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>2. Runloop | Funky&#39;s blog</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/funkyblog/logo.jpg">
    <meta name="description" content="Funky的个人技术博客">
    
    <link rel="preload" href="/funkyblog/assets/css/0.styles.c5671824.css" as="style"><link rel="preload" href="/funkyblog/assets/js/app.a24b3efd.js" as="script"><link rel="preload" href="/funkyblog/assets/js/2.3aea1f50.js" as="script"><link rel="preload" href="/funkyblog/assets/js/59.62f0670e.js" as="script"><link rel="prefetch" href="/funkyblog/assets/js/10.fdb72551.js"><link rel="prefetch" href="/funkyblog/assets/js/100.322ef7c3.js"><link rel="prefetch" href="/funkyblog/assets/js/101.7adabe50.js"><link rel="prefetch" href="/funkyblog/assets/js/102.b672d5b4.js"><link rel="prefetch" href="/funkyblog/assets/js/103.cbd5f57f.js"><link rel="prefetch" href="/funkyblog/assets/js/104.98c6bdcb.js"><link rel="prefetch" href="/funkyblog/assets/js/105.51f7efcb.js"><link rel="prefetch" href="/funkyblog/assets/js/106.bcdfddc5.js"><link rel="prefetch" href="/funkyblog/assets/js/107.000a9752.js"><link rel="prefetch" href="/funkyblog/assets/js/108.92133c7f.js"><link rel="prefetch" href="/funkyblog/assets/js/109.249e3002.js"><link rel="prefetch" href="/funkyblog/assets/js/11.8d7a0728.js"><link rel="prefetch" href="/funkyblog/assets/js/110.a116e6e3.js"><link rel="prefetch" href="/funkyblog/assets/js/111.5d78ef12.js"><link rel="prefetch" href="/funkyblog/assets/js/112.2c266219.js"><link rel="prefetch" href="/funkyblog/assets/js/113.480d3824.js"><link rel="prefetch" href="/funkyblog/assets/js/114.fa1b4ab2.js"><link rel="prefetch" href="/funkyblog/assets/js/115.d65cb78a.js"><link rel="prefetch" href="/funkyblog/assets/js/116.33a2e878.js"><link rel="prefetch" href="/funkyblog/assets/js/117.bbd07ef4.js"><link rel="prefetch" href="/funkyblog/assets/js/118.0dedd5d9.js"><link rel="prefetch" href="/funkyblog/assets/js/119.5a13d359.js"><link rel="prefetch" href="/funkyblog/assets/js/12.84a022d2.js"><link rel="prefetch" href="/funkyblog/assets/js/120.6d8406bc.js"><link rel="prefetch" href="/funkyblog/assets/js/121.1535eb29.js"><link rel="prefetch" href="/funkyblog/assets/js/122.25226b03.js"><link rel="prefetch" href="/funkyblog/assets/js/123.00d7c304.js"><link rel="prefetch" href="/funkyblog/assets/js/124.16802c94.js"><link rel="prefetch" href="/funkyblog/assets/js/125.541331b4.js"><link rel="prefetch" href="/funkyblog/assets/js/126.8eec9a18.js"><link rel="prefetch" href="/funkyblog/assets/js/127.d14ed3d3.js"><link rel="prefetch" href="/funkyblog/assets/js/13.fe7b989e.js"><link rel="prefetch" href="/funkyblog/assets/js/14.06c2893e.js"><link rel="prefetch" href="/funkyblog/assets/js/15.7db30254.js"><link rel="prefetch" href="/funkyblog/assets/js/16.f5c8a3a0.js"><link rel="prefetch" href="/funkyblog/assets/js/17.ee25e8b2.js"><link rel="prefetch" href="/funkyblog/assets/js/18.138ba97b.js"><link rel="prefetch" href="/funkyblog/assets/js/19.7b046ac4.js"><link rel="prefetch" href="/funkyblog/assets/js/20.93aa8f6a.js"><link rel="prefetch" href="/funkyblog/assets/js/21.b422e4c4.js"><link rel="prefetch" href="/funkyblog/assets/js/22.4b4fa0d1.js"><link rel="prefetch" href="/funkyblog/assets/js/23.3135691d.js"><link rel="prefetch" href="/funkyblog/assets/js/24.5ed690d9.js"><link rel="prefetch" href="/funkyblog/assets/js/25.599c60f6.js"><link rel="prefetch" href="/funkyblog/assets/js/26.9388b7c2.js"><link rel="prefetch" href="/funkyblog/assets/js/27.a17039b1.js"><link rel="prefetch" href="/funkyblog/assets/js/28.51a65ac9.js"><link rel="prefetch" href="/funkyblog/assets/js/29.ca8f9960.js"><link rel="prefetch" href="/funkyblog/assets/js/3.90f0fac9.js"><link rel="prefetch" href="/funkyblog/assets/js/30.c93ba89f.js"><link rel="prefetch" href="/funkyblog/assets/js/31.1739efda.js"><link rel="prefetch" href="/funkyblog/assets/js/32.3d6133c5.js"><link rel="prefetch" href="/funkyblog/assets/js/33.ea1b693d.js"><link rel="prefetch" href="/funkyblog/assets/js/34.f5f68409.js"><link rel="prefetch" href="/funkyblog/assets/js/35.fe8276f9.js"><link rel="prefetch" href="/funkyblog/assets/js/36.7dfbbc31.js"><link rel="prefetch" href="/funkyblog/assets/js/37.38292e55.js"><link rel="prefetch" href="/funkyblog/assets/js/38.814bd863.js"><link rel="prefetch" href="/funkyblog/assets/js/39.ff4fbd9f.js"><link rel="prefetch" href="/funkyblog/assets/js/4.bf89a90b.js"><link rel="prefetch" href="/funkyblog/assets/js/40.b78c54dc.js"><link rel="prefetch" href="/funkyblog/assets/js/41.f17fe040.js"><link rel="prefetch" href="/funkyblog/assets/js/42.83583d5d.js"><link rel="prefetch" href="/funkyblog/assets/js/43.deed3fdd.js"><link rel="prefetch" href="/funkyblog/assets/js/44.8033ac93.js"><link rel="prefetch" href="/funkyblog/assets/js/45.78c09822.js"><link rel="prefetch" href="/funkyblog/assets/js/46.dc92e91d.js"><link rel="prefetch" href="/funkyblog/assets/js/47.58c20506.js"><link rel="prefetch" href="/funkyblog/assets/js/48.03e8e813.js"><link rel="prefetch" href="/funkyblog/assets/js/49.51f46791.js"><link rel="prefetch" href="/funkyblog/assets/js/5.f6f2e860.js"><link rel="prefetch" href="/funkyblog/assets/js/50.d62f902a.js"><link rel="prefetch" href="/funkyblog/assets/js/51.2f77c15c.js"><link rel="prefetch" href="/funkyblog/assets/js/52.14d3dba9.js"><link rel="prefetch" href="/funkyblog/assets/js/53.9598cf79.js"><link rel="prefetch" href="/funkyblog/assets/js/54.669e4f25.js"><link rel="prefetch" href="/funkyblog/assets/js/55.aeb878b8.js"><link rel="prefetch" href="/funkyblog/assets/js/56.23f25070.js"><link rel="prefetch" href="/funkyblog/assets/js/57.f048233b.js"><link rel="prefetch" href="/funkyblog/assets/js/58.f3967f69.js"><link rel="prefetch" href="/funkyblog/assets/js/6.6d922041.js"><link rel="prefetch" href="/funkyblog/assets/js/60.016ba18c.js"><link rel="prefetch" href="/funkyblog/assets/js/61.b5d2cff8.js"><link rel="prefetch" href="/funkyblog/assets/js/62.ac5f87fe.js"><link rel="prefetch" href="/funkyblog/assets/js/63.d9a60137.js"><link rel="prefetch" href="/funkyblog/assets/js/64.b591a667.js"><link rel="prefetch" href="/funkyblog/assets/js/65.e768c8e9.js"><link rel="prefetch" href="/funkyblog/assets/js/66.5f46813d.js"><link rel="prefetch" href="/funkyblog/assets/js/67.02b3f46c.js"><link rel="prefetch" href="/funkyblog/assets/js/68.676ba975.js"><link rel="prefetch" href="/funkyblog/assets/js/69.e031cc98.js"><link rel="prefetch" href="/funkyblog/assets/js/7.7a61e41b.js"><link rel="prefetch" href="/funkyblog/assets/js/70.94a805bd.js"><link rel="prefetch" href="/funkyblog/assets/js/71.281fda5b.js"><link rel="prefetch" href="/funkyblog/assets/js/72.290763cf.js"><link rel="prefetch" href="/funkyblog/assets/js/73.21b036b0.js"><link rel="prefetch" href="/funkyblog/assets/js/74.df7e87b8.js"><link rel="prefetch" href="/funkyblog/assets/js/75.a73c1199.js"><link rel="prefetch" href="/funkyblog/assets/js/76.44658040.js"><link rel="prefetch" href="/funkyblog/assets/js/77.bd56a926.js"><link rel="prefetch" href="/funkyblog/assets/js/78.09a51bc3.js"><link rel="prefetch" href="/funkyblog/assets/js/79.cb143284.js"><link rel="prefetch" href="/funkyblog/assets/js/8.708c7e46.js"><link rel="prefetch" href="/funkyblog/assets/js/80.f134bc8b.js"><link rel="prefetch" href="/funkyblog/assets/js/81.12483621.js"><link rel="prefetch" href="/funkyblog/assets/js/82.e41901b3.js"><link rel="prefetch" href="/funkyblog/assets/js/83.5c039041.js"><link rel="prefetch" href="/funkyblog/assets/js/84.c4c06788.js"><link rel="prefetch" href="/funkyblog/assets/js/85.bced8698.js"><link rel="prefetch" href="/funkyblog/assets/js/86.5315ed66.js"><link rel="prefetch" href="/funkyblog/assets/js/87.4ea61a5c.js"><link rel="prefetch" href="/funkyblog/assets/js/88.aa62f043.js"><link rel="prefetch" href="/funkyblog/assets/js/89.0eb25b80.js"><link rel="prefetch" href="/funkyblog/assets/js/9.e076e28d.js"><link rel="prefetch" href="/funkyblog/assets/js/90.7f136876.js"><link rel="prefetch" href="/funkyblog/assets/js/91.12c27e63.js"><link rel="prefetch" href="/funkyblog/assets/js/92.e2ffad27.js"><link rel="prefetch" href="/funkyblog/assets/js/93.a08e3a15.js"><link rel="prefetch" href="/funkyblog/assets/js/94.977d3ede.js"><link rel="prefetch" href="/funkyblog/assets/js/95.f8e1328d.js"><link rel="prefetch" href="/funkyblog/assets/js/96.c119e0f7.js"><link rel="prefetch" href="/funkyblog/assets/js/97.e483280d.js"><link rel="prefetch" href="/funkyblog/assets/js/98.0f1eb7a4.js"><link rel="prefetch" href="/funkyblog/assets/js/99.7813329f.js">
    <link rel="stylesheet" href="/funkyblog/assets/css/0.styles.c5671824.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/funkyblog/" class="home-link router-link-active"><img src="/funkyblog/logo.jpg" alt="Funky's blog" class="logo"> <span class="site-name can-hide">Funky's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/funkyblog/" class="nav-link">
  Guide
</a></div><div class="nav-item"><a href="/funkyblog/flutter/" class="nav-link">
  Flutter
</a></div><div class="nav-item"><a href="/funkyblog/server/" class="nav-link">
  Server
</a></div><div class="nav-item"><a href="/funkyblog/web/" class="nav-link">
  Web
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/funkyblog/" class="nav-link">
  Guide
</a></div><div class="nav-item"><a href="/funkyblog/flutter/" class="nav-link">
  Flutter
</a></div><div class="nav-item"><a href="/funkyblog/server/" class="nav-link">
  Server
</a></div><div class="nav-item"><a href="/funkyblog/web/" class="nav-link">
  Web
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>iOS基础</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/funkyblog/ios/main/1-runtime/" class="sidebar-link">1. Runtime</a></li><li><a href="/funkyblog/ios/main/2-runloop/" aria-current="page" class="active sidebar-link">2. Runloop</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/funkyblog/ios/main/2-runloop/#_1-基础知识" class="sidebar-link">1. 基础知识</a></li><li class="sidebar-sub-header"><a href="/funkyblog/ios/main/2-runloop/#_2-runloop对象" class="sidebar-link">2. RunLoop对象</a></li><li class="sidebar-sub-header"><a href="/funkyblog/ios/main/2-runloop/#_3-runloop与线程" class="sidebar-link">3. RunLoop与线程</a></li><li class="sidebar-sub-header"><a href="/funkyblog/ios/main/2-runloop/#_4-获得runloop对象" class="sidebar-link">4. 获得RunLoop对象</a></li><li class="sidebar-sub-header"><a href="/funkyblog/ios/main/2-runloop/#_5-runloop相关类" class="sidebar-link">5. RunLoop相关类</a></li><li class="sidebar-sub-header"><a href="/funkyblog/ios/main/2-runloop/#_6-runloop处理逻辑" class="sidebar-link">6. RunLoop处理逻辑</a></li><li class="sidebar-sub-header"><a href="/funkyblog/ios/main/2-runloop/#_7-自动释放池与runloop" class="sidebar-link">7. 自动释放池与RunLoop</a></li><li class="sidebar-sub-header"><a href="/funkyblog/ios/main/2-runloop/#_8-视频学习记录" class="sidebar-link">8. 视频学习记录</a></li><li class="sidebar-sub-header"><a href="/funkyblog/ios/main/2-runloop/#_9-runloop的mode是如何切换的-runloop的mode切换时-上一个mode是需要退出吗" class="sidebar-link">9. Runloop的mode是如何切换的？Runloop的mode切换时，上一个mode是需要退出吗？</a></li></ul></li><li><a href="/funkyblog/ios/main/3-thread/" class="sidebar-link">3. 多线程</a></li><li><a href="/funkyblog/ios/main/4-block/" class="sidebar-link">4. Blocks</a></li><li><a href="/funkyblog/ios/main/5-kvc-kvo/" class="sidebar-link">5. KVC/KVO</a></li><li><a href="/funkyblog/ios/main/6-arc/" class="sidebar-link">6. 自动引用计数</a></li><li><a href="/funkyblog/ios/main/7-instrument/" class="sidebar-link">7. Instrument</a></li><li><a href="/funkyblog/ios/main/8-copy/" class="sidebar-link">8. 深拷贝与浅拷贝</a></li><li><a href="/funkyblog/ios/main/9-llvm/" class="sidebar-link">9. 编译器</a></li><li><a href="/funkyblog/ios/main/10-module/" class="sidebar-link">10. 组件化</a></li><li><a href="/funkyblog/ios/main/11-ble/" class="sidebar-link">11. BLE</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>OC学习</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Swift学习</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p></p><div class="table-of-contents"><ul><li><a href="#_1-基础知识">1. 基础知识</a><ul><li><a href="#如果没有runloop">如果没有RunLoop</a></li><li><a href="#如果有runloop">如果有Runloop</a></li><li><a href="#main函数中的runloop">main函数中的RunLoop</a></li><li><a href="#runloop作用">Runloop作用</a></li></ul></li><li><a href="#_2-runloop对象">2. RunLoop对象</a><ul><li><a href="#ios中有2套api来访问和使用runloop">iOS中有2套API来访问和使用RunLoop</a></li></ul></li><li><a href="#_3-runloop与线程">3. RunLoop与线程</a></li><li><a href="#_4-获得runloop对象">4. 获得RunLoop对象</a></li><li><a href="#_5-runloop相关类">5. RunLoop相关类</a><ul><li><a href="#core-foundation中关于runloop的5个类">Core Foundation中关于RunLoop的5个类</a></li><li><a href="#cfrunloopmoderef">CFRunLoopModeRef</a></li><li><a href="#cfrunloopsourceref">CFRunLoopSourceRef</a></li><li><a href="#cfrunlooptimerref">CFRunLoopTimerRef</a></li><li><a href="#cfrunloopobserverref">CFRunLoopObserverRef</a></li></ul></li><li><a href="#_6-runloop处理逻辑">6. RunLoop处理逻辑</a></li><li><a href="#_7-自动释放池与runloop">7. 自动释放池与RunLoop</a></li><li><a href="#_8-视频学习记录">8. 视频学习记录</a><ul><li><a href="#为什么点击屏幕会唤醒runloop">为什么点击屏幕会唤醒RunLoop？</a></li><li><a href="#可以唤醒runloop的事件">可以唤醒Runloop的事件</a></li></ul></li><li><a href="#_9-runloop的mode是如何切换的-runloop的mode切换时-上一个mode是需要退出吗">9. Runloop的mode是如何切换的？Runloop的mode切换时，上一个mode是需要退出吗？</a></li></ul></div><p></p> <h1 id="runloop"><a href="#runloop" class="header-anchor">#</a> Runloop</h1> <h2 id="_1-基础知识"><a href="#_1-基础知识" class="header-anchor">#</a> 1. 基础知识</h2> <h3 id="如果没有runloop"><a href="#如果没有runloop" class="header-anchor">#</a> 如果没有RunLoop</h3> <h3 id="如果有runloop"><a href="#如果有runloop" class="header-anchor">#</a> 如果有Runloop</h3> <h3 id="main函数中的runloop"><a href="#main函数中的runloop" class="header-anchor">#</a> main函数中的RunLoop</h3> <ul><li>UIApplicationMain函数内部就启动了一个RunLoop，所以UIApplicationMain函数一直没有返回，保持了程序的持续运行</li> <li>这个默认启动的RunLoop是跟主线程相关联的</li></ul> <h3 id="runloop作用"><a href="#runloop作用" class="header-anchor">#</a> Runloop作用</h3> <ul><li>保持程序的持续运行</li> <li>处理app中的各种事件（比如触摸事件、定时器事件【NSTimer】、selector事件【选择器performSelector···】）</li> <li>节省CPU资源，提高程序性能，有事情就做事情，没事情就休息</li></ul> <h2 id="_2-runloop对象"><a href="#_2-runloop对象" class="header-anchor">#</a> 2. RunLoop对象</h2> <h3 id="ios中有2套api来访问和使用runloop"><a href="#ios中有2套api来访问和使用runloop" class="header-anchor">#</a> iOS中有2套API来访问和使用RunLoop</h3> <ul><li>Foundation：NSRunLoop</li> <li>Core Foundation：CFRunLoopRef</li> <li>NSRunLoop和CFRunLoopRef都代表着RunLoop对象，NSRunLoop是基于CFRunLoopRef的一层OC包装，所以要了解RunLoop内部结构，需要多研究CFRunLoopRef层面的API（Core Foundation层面）</li></ul> <h2 id="_3-runloop与线程"><a href="#_3-runloop与线程" class="header-anchor">#</a> 3. RunLoop与线程</h2> <ul><li>每条线程都有唯一的一个与之对应的RunLoop对象</li> <li>如何让子线程不死：给这条子线程开启一个Runloop</li> <li>主线程的RunLoop已经自动创建好了，子线程的RunLoop需要主动创建，如果不主动获取Runloop的话，那么子线程内部是不会创建Runloop的。可以下载CFRunloopRef的源码，搜索_CFRunloopGet0,查看代码</li> <li>Runloop的生命周期：RunLoop在第一次获取时创建，在线程结束时销毁</li> <li>Runloop对象是利用字典来进行存储，而且key是对应的线程Value为该线程对应的Runloop。</li></ul> <h2 id="_4-获得runloop对象"><a href="#_4-获得runloop对象" class="header-anchor">#</a> 4. 获得RunLoop对象</h2> <div class="language-oc extra-class"><pre class="language-text"><code>// Foundation
[NSRunLoop currentRunLoop];  // 获得当前线程的RunLoop对象
[NSRunLoop mainRunLoop];       // 获得主线程的RunLoop对象

// Core Foundation
CFRunLoopGetCurrent();  // 获得当前线程的RunLoop对象
CFRunLoopGetMain();     // 获得主线程的RunLoop对象 
</code></pre></div><h2 id="_5-runloop相关类"><a href="#_5-runloop相关类" class="header-anchor">#</a> 5. RunLoop相关类</h2> <h3 id="core-foundation中关于runloop的5个类"><a href="#core-foundation中关于runloop的5个类" class="header-anchor">#</a> Core Foundation中关于RunLoop的5个类</h3> <div class="language- extra-class"><pre><code>- CFRunLoopRef:它自己,也就代表一个RunLoop对象
- CFRunLoopModeRef :RunLoop的运行模式
- CFRunLoopSourceRef :事件源
- CFRunLoopTimerRef :时间的触发器
- CFRunLoopObserverRef :观察者 监听CFRunLoopRef的状态改变
</code></pre></div><h3 id="cfrunloopmoderef"><a href="#cfrunloopmoderef" class="header-anchor">#</a> CFRunLoopModeRef</h3> <ul><li>CFRunLoopModeRef代表RunLoop的运行模式</li> <li>一个 RunLoop 包含若干个 Mode，每个Mode又包含若干个Source/Timer/Observer</li> <li>每次RunLoop启动时，只能指定其中一个 Mode，这个Mode被称作 CurrentMode</li> <li>如果需要切换Mode，只能退出Loop，再重新指定一个Mode进入，这样做主要是为了分隔开不同组的Source/Timer/Observer，让其互不影响</li> <li>系统默认注册了5个Mode模式:
<ul><li><code>kCFRunLoopDefaultMode</code>：App的默认Mode，通常主线程是在这个Mode下运行</li> <li><code>UITrackingRunLoopMode</code>：界面跟踪 Mode，用于 ScrollView 追踪触摸滑动，保证界面滑动时不受其他 Mode 影响</li> <li><code>UIInitializationRunLoopMode</code>: 在刚启动 App 时第进入的第一个 Mode，启动完成后就不再使用</li> <li><code>GSEventReceiveRunLoopMode</code>: 接受系统事件的内部 Mode，通常用不到</li> <li><code>kCFRunLoopCommonModes</code>: 这是一个占位用的Mode，不是一种真正的Mode</li></ul></li></ul> <h3 id="cfrunloopsourceref"><a href="#cfrunloopsourceref" class="header-anchor">#</a> CFRunLoopSourceRef</h3> <ul><li>CFRunLoopSourceRef是事件源（输入源）</li> <li>以前的分法： Port-Based Sources、Custom Input Sources、Cocoa Perform Selector Sources</li> <li>现在的分法：
<ul><li>Source0：不基于Port的（用户主动触发的事件）</li> <li>Source1：基于Port的（系统内部的消息事件）</li></ul></li> <li>(Port是线程间通信的一种方式，如果两个线程之间想通信，可以通过Port来通信。)</li></ul> <h3 id="cfrunlooptimerref"><a href="#cfrunlooptimerref" class="header-anchor">#</a> CFRunLoopTimerRef</h3> <ul><li>CFRunLoopTimerRef是基于时间的触发器，基本上说的就是NSTimer</li></ul> <h3 id="cfrunloopobserverref"><a href="#cfrunloopobserverref" class="header-anchor">#</a> CFRunLoopObserverRef</h3> <ul><li>CFRunLoopObserverRef是观察者，能够监听RunLoop的状态改变</li> <li>可以监听的时间点有一下几个：</li></ul> <h2 id="_6-runloop处理逻辑"><a href="#_6-runloop处理逻辑" class="header-anchor">#</a> 6. RunLoop处理逻辑</h2> <h2 id="_7-自动释放池与runloop"><a href="#_7-自动释放池与runloop" class="header-anchor">#</a> 7. 自动释放池与RunLoop</h2> <ul><li><code>kCFRunLoopEntry;</code> 即将进入loop，此时创建一个自动释放池</li> <li><code>kCFRunLoopBeforeWaiting;</code> 即将进入休眠，此时销毁自动释放池，创建一个新的自动释放池</li> <li><code>kCFRunLoopExit;</code>  即将退出loop，此时销毁自动释放池</li> <li>自动释放池的创建和销毁
<ul><li>第一次创建:当runloop启动的时候</li> <li>最后一次销毁:当runloop退出的时候</li> <li>其它创建和销毁:当runloop进入到睡觉状态的时候会把之前的自动释放池销毁,重新创建一个新的</li></ul></li></ul> <h2 id="_8-视频学习记录"><a href="#_8-视频学习记录" class="header-anchor">#</a> 8. 视频学习记录</h2> <ul><li>链接：https://www.bilibili.com/video/BV1Bv411z774?from=search&amp;seid=7583525792558693256</li></ul> <h3 id="为什么点击屏幕会唤醒runloop"><a href="#为什么点击屏幕会唤醒runloop" class="header-anchor">#</a> 为什么点击屏幕会唤醒RunLoop？</h3> <ul><li><p>首先是硬件，把触摸/锁屏/摇晃等事件 通过IOKit.framework，将用户的行为封装成IOHIDEvent，传递给iOS的桌面管理系统SpringBoard，SpringBoard通过跨进程通讯mach port传递给App，App触发Source1回调方法__IOHIDEventSystemClientQueueCallback，通过Source1在触发Source0回调方法_UIApplicationHandleEventQueue，将其包装成UIEvent，最后发送给UIWindow，UIWindow在去分发，最后响应到TouchBegin方法</p></li> <li><p>mach port其实是跨线程通讯，但是跨进程通讯本质上也是基于mach port，例如iOS上的剪切板</p></li> <li><p>通过lldb调试台打断点查看__IOHIDEventSystemClientQueueCallback方法的回调：</p></li> <li><p>bt可以查看当前调用栈</p></li></ul> <h3 id="可以唤醒runloop的事件"><a href="#可以唤醒runloop的事件" class="header-anchor">#</a> 可以唤醒Runloop的事件</h3> <ul><li><p>timer</p></li> <li><p>source，到底是source0唤醒的还是source1唤醒的</p></li> <li><p>Source0：不能主动触发，先调用CFRunLoopSourceSignal(source)，将这个Source标记为待处理。CFRunLoopWakeUp(runloop)来唤醒Runloop，让其处理这个事件</p></li> <li><p>Source1：基于mach_port，用于通过内核和其他线程相互发送消息，这种Source能主动唤醒RunLoop的线程</p></li></ul> <h2 id="_9-runloop的mode是如何切换的-runloop的mode切换时-上一个mode是需要退出吗"><a href="#_9-runloop的mode是如何切换的-runloop的mode切换时-上一个mode是需要退出吗" class="header-anchor">#</a> 9. Runloop的mode是如何切换的？Runloop的mode切换时，上一个mode是需要退出吗？</h2> <ul><li>UITableView滑动时，Runloop会进行切换mode，由kCFRunLoopDefaultMode切换为UITrackingRunLoopMode，根据源码，切换mode实际是调用CFRunLoopRunSpecific 这个函数</li> <li>Runloop的mode切换时，上一个mode会退出</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/funkyblog/ios/main/1-runtime/" class="prev">
        1. Runtime
      </a></span> <span class="next"><a href="/funkyblog/ios/main/3-thread/">
        3. 多线程
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/funkyblog/assets/js/app.a24b3efd.js" defer></script><script src="/funkyblog/assets/js/2.3aea1f50.js" defer></script><script src="/funkyblog/assets/js/59.62f0670e.js" defer></script>
  </body>
</html>
