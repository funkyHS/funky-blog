<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>1. 微信订阅号一 | Funky&#39;s blog</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/funkyblog/logo.jpg">
    <meta name="description" content="Funky的个人技术博客">
    
    <link rel="preload" href="/funkyblog/assets/css/0.styles.c5671824.css" as="style"><link rel="preload" href="/funkyblog/assets/js/app.a24b3efd.js" as="script"><link rel="preload" href="/funkyblog/assets/js/2.3aea1f50.js" as="script"><link rel="preload" href="/funkyblog/assets/js/126.8eec9a18.js" as="script"><link rel="prefetch" href="/funkyblog/assets/js/10.fdb72551.js"><link rel="prefetch" href="/funkyblog/assets/js/100.322ef7c3.js"><link rel="prefetch" href="/funkyblog/assets/js/101.7adabe50.js"><link rel="prefetch" href="/funkyblog/assets/js/102.b672d5b4.js"><link rel="prefetch" href="/funkyblog/assets/js/103.cbd5f57f.js"><link rel="prefetch" href="/funkyblog/assets/js/104.98c6bdcb.js"><link rel="prefetch" href="/funkyblog/assets/js/105.51f7efcb.js"><link rel="prefetch" href="/funkyblog/assets/js/106.bcdfddc5.js"><link rel="prefetch" href="/funkyblog/assets/js/107.000a9752.js"><link rel="prefetch" href="/funkyblog/assets/js/108.92133c7f.js"><link rel="prefetch" href="/funkyblog/assets/js/109.249e3002.js"><link rel="prefetch" href="/funkyblog/assets/js/11.8d7a0728.js"><link rel="prefetch" href="/funkyblog/assets/js/110.a116e6e3.js"><link rel="prefetch" href="/funkyblog/assets/js/111.5d78ef12.js"><link rel="prefetch" href="/funkyblog/assets/js/112.2c266219.js"><link rel="prefetch" href="/funkyblog/assets/js/113.480d3824.js"><link rel="prefetch" href="/funkyblog/assets/js/114.fa1b4ab2.js"><link rel="prefetch" href="/funkyblog/assets/js/115.d65cb78a.js"><link rel="prefetch" href="/funkyblog/assets/js/116.33a2e878.js"><link rel="prefetch" href="/funkyblog/assets/js/117.bbd07ef4.js"><link rel="prefetch" href="/funkyblog/assets/js/118.0dedd5d9.js"><link rel="prefetch" href="/funkyblog/assets/js/119.5a13d359.js"><link rel="prefetch" href="/funkyblog/assets/js/12.84a022d2.js"><link rel="prefetch" href="/funkyblog/assets/js/120.6d8406bc.js"><link rel="prefetch" href="/funkyblog/assets/js/121.1535eb29.js"><link rel="prefetch" href="/funkyblog/assets/js/122.25226b03.js"><link rel="prefetch" href="/funkyblog/assets/js/123.00d7c304.js"><link rel="prefetch" href="/funkyblog/assets/js/124.16802c94.js"><link rel="prefetch" href="/funkyblog/assets/js/125.541331b4.js"><link rel="prefetch" href="/funkyblog/assets/js/127.d14ed3d3.js"><link rel="prefetch" href="/funkyblog/assets/js/13.fe7b989e.js"><link rel="prefetch" href="/funkyblog/assets/js/14.06c2893e.js"><link rel="prefetch" href="/funkyblog/assets/js/15.7db30254.js"><link rel="prefetch" href="/funkyblog/assets/js/16.f5c8a3a0.js"><link rel="prefetch" href="/funkyblog/assets/js/17.ee25e8b2.js"><link rel="prefetch" href="/funkyblog/assets/js/18.138ba97b.js"><link rel="prefetch" href="/funkyblog/assets/js/19.7b046ac4.js"><link rel="prefetch" href="/funkyblog/assets/js/20.93aa8f6a.js"><link rel="prefetch" href="/funkyblog/assets/js/21.b422e4c4.js"><link rel="prefetch" href="/funkyblog/assets/js/22.4b4fa0d1.js"><link rel="prefetch" href="/funkyblog/assets/js/23.3135691d.js"><link rel="prefetch" href="/funkyblog/assets/js/24.5ed690d9.js"><link rel="prefetch" href="/funkyblog/assets/js/25.599c60f6.js"><link rel="prefetch" href="/funkyblog/assets/js/26.9388b7c2.js"><link rel="prefetch" href="/funkyblog/assets/js/27.a17039b1.js"><link rel="prefetch" href="/funkyblog/assets/js/28.51a65ac9.js"><link rel="prefetch" href="/funkyblog/assets/js/29.ca8f9960.js"><link rel="prefetch" href="/funkyblog/assets/js/3.90f0fac9.js"><link rel="prefetch" href="/funkyblog/assets/js/30.c93ba89f.js"><link rel="prefetch" href="/funkyblog/assets/js/31.1739efda.js"><link rel="prefetch" href="/funkyblog/assets/js/32.3d6133c5.js"><link rel="prefetch" href="/funkyblog/assets/js/33.ea1b693d.js"><link rel="prefetch" href="/funkyblog/assets/js/34.f5f68409.js"><link rel="prefetch" href="/funkyblog/assets/js/35.fe8276f9.js"><link rel="prefetch" href="/funkyblog/assets/js/36.7dfbbc31.js"><link rel="prefetch" href="/funkyblog/assets/js/37.38292e55.js"><link rel="prefetch" href="/funkyblog/assets/js/38.814bd863.js"><link rel="prefetch" href="/funkyblog/assets/js/39.ff4fbd9f.js"><link rel="prefetch" href="/funkyblog/assets/js/4.bf89a90b.js"><link rel="prefetch" href="/funkyblog/assets/js/40.b78c54dc.js"><link rel="prefetch" href="/funkyblog/assets/js/41.f17fe040.js"><link rel="prefetch" href="/funkyblog/assets/js/42.83583d5d.js"><link rel="prefetch" href="/funkyblog/assets/js/43.deed3fdd.js"><link rel="prefetch" href="/funkyblog/assets/js/44.8033ac93.js"><link rel="prefetch" href="/funkyblog/assets/js/45.78c09822.js"><link rel="prefetch" href="/funkyblog/assets/js/46.dc92e91d.js"><link rel="prefetch" href="/funkyblog/assets/js/47.58c20506.js"><link rel="prefetch" href="/funkyblog/assets/js/48.03e8e813.js"><link rel="prefetch" href="/funkyblog/assets/js/49.51f46791.js"><link rel="prefetch" href="/funkyblog/assets/js/5.f6f2e860.js"><link rel="prefetch" href="/funkyblog/assets/js/50.d62f902a.js"><link rel="prefetch" href="/funkyblog/assets/js/51.2f77c15c.js"><link rel="prefetch" href="/funkyblog/assets/js/52.14d3dba9.js"><link rel="prefetch" href="/funkyblog/assets/js/53.9598cf79.js"><link rel="prefetch" href="/funkyblog/assets/js/54.669e4f25.js"><link rel="prefetch" href="/funkyblog/assets/js/55.aeb878b8.js"><link rel="prefetch" href="/funkyblog/assets/js/56.23f25070.js"><link rel="prefetch" href="/funkyblog/assets/js/57.f048233b.js"><link rel="prefetch" href="/funkyblog/assets/js/58.f3967f69.js"><link rel="prefetch" href="/funkyblog/assets/js/59.62f0670e.js"><link rel="prefetch" href="/funkyblog/assets/js/6.6d922041.js"><link rel="prefetch" href="/funkyblog/assets/js/60.016ba18c.js"><link rel="prefetch" href="/funkyblog/assets/js/61.b5d2cff8.js"><link rel="prefetch" href="/funkyblog/assets/js/62.ac5f87fe.js"><link rel="prefetch" href="/funkyblog/assets/js/63.d9a60137.js"><link rel="prefetch" href="/funkyblog/assets/js/64.b591a667.js"><link rel="prefetch" href="/funkyblog/assets/js/65.e768c8e9.js"><link rel="prefetch" href="/funkyblog/assets/js/66.5f46813d.js"><link rel="prefetch" href="/funkyblog/assets/js/67.02b3f46c.js"><link rel="prefetch" href="/funkyblog/assets/js/68.676ba975.js"><link rel="prefetch" href="/funkyblog/assets/js/69.e031cc98.js"><link rel="prefetch" href="/funkyblog/assets/js/7.7a61e41b.js"><link rel="prefetch" href="/funkyblog/assets/js/70.94a805bd.js"><link rel="prefetch" href="/funkyblog/assets/js/71.281fda5b.js"><link rel="prefetch" href="/funkyblog/assets/js/72.290763cf.js"><link rel="prefetch" href="/funkyblog/assets/js/73.21b036b0.js"><link rel="prefetch" href="/funkyblog/assets/js/74.df7e87b8.js"><link rel="prefetch" href="/funkyblog/assets/js/75.a73c1199.js"><link rel="prefetch" href="/funkyblog/assets/js/76.44658040.js"><link rel="prefetch" href="/funkyblog/assets/js/77.bd56a926.js"><link rel="prefetch" href="/funkyblog/assets/js/78.09a51bc3.js"><link rel="prefetch" href="/funkyblog/assets/js/79.cb143284.js"><link rel="prefetch" href="/funkyblog/assets/js/8.708c7e46.js"><link rel="prefetch" href="/funkyblog/assets/js/80.f134bc8b.js"><link rel="prefetch" href="/funkyblog/assets/js/81.12483621.js"><link rel="prefetch" href="/funkyblog/assets/js/82.e41901b3.js"><link rel="prefetch" href="/funkyblog/assets/js/83.5c039041.js"><link rel="prefetch" href="/funkyblog/assets/js/84.c4c06788.js"><link rel="prefetch" href="/funkyblog/assets/js/85.bced8698.js"><link rel="prefetch" href="/funkyblog/assets/js/86.5315ed66.js"><link rel="prefetch" href="/funkyblog/assets/js/87.4ea61a5c.js"><link rel="prefetch" href="/funkyblog/assets/js/88.aa62f043.js"><link rel="prefetch" href="/funkyblog/assets/js/89.0eb25b80.js"><link rel="prefetch" href="/funkyblog/assets/js/9.e076e28d.js"><link rel="prefetch" href="/funkyblog/assets/js/90.7f136876.js"><link rel="prefetch" href="/funkyblog/assets/js/91.12c27e63.js"><link rel="prefetch" href="/funkyblog/assets/js/92.e2ffad27.js"><link rel="prefetch" href="/funkyblog/assets/js/93.a08e3a15.js"><link rel="prefetch" href="/funkyblog/assets/js/94.977d3ede.js"><link rel="prefetch" href="/funkyblog/assets/js/95.f8e1328d.js"><link rel="prefetch" href="/funkyblog/assets/js/96.c119e0f7.js"><link rel="prefetch" href="/funkyblog/assets/js/97.e483280d.js"><link rel="prefetch" href="/funkyblog/assets/js/98.0f1eb7a4.js"><link rel="prefetch" href="/funkyblog/assets/js/99.7813329f.js">
    <link rel="stylesheet" href="/funkyblog/assets/css/0.styles.c5671824.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/funkyblog/" class="home-link router-link-active"><img src="/funkyblog/logo.jpg" alt="Funky's blog" class="logo"> <span class="site-name can-hide">Funky's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/funkyblog/" class="nav-link">
  Guide
</a></div><div class="nav-item"><a href="/funkyblog/flutter/" class="nav-link">
  Flutter
</a></div><div class="nav-item"><a href="/funkyblog/server/" class="nav-link">
  Server
</a></div><div class="nav-item"><a href="/funkyblog/web/" class="nav-link router-link-active">
  Web
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/funkyblog/" class="nav-link">
  Guide
</a></div><div class="nav-item"><a href="/funkyblog/flutter/" class="nav-link">
  Flutter
</a></div><div class="nav-item"><a href="/funkyblog/server/" class="nav-link">
  Server
</a></div><div class="nav-item"><a href="/funkyblog/web/" class="nav-link router-link-active">
  Web
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Vue</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Vue项目-电影卖座</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>微信公众平台</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/funkyblog/web/wxpublic/wxpublic1/" aria-current="page" class="active sidebar-link">1. 微信订阅号一</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/funkyblog/web/wxpublic/wxpublic1/#_1-公众号类型及基本介绍" class="sidebar-link">1. 公众号类型及基本介绍</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/funkyblog/web/wxpublic/wxpublic1/#账号分类" class="sidebar-link">账号分类</a></li><li class="sidebar-sub-header"><a href="/funkyblog/web/wxpublic/wxpublic1/#注册个人订阅号" class="sidebar-link">注册个人订阅号</a></li></ul></li><li class="sidebar-sub-header"><a href="/funkyblog/web/wxpublic/wxpublic1/#_2-编辑模式-微信订阅号自带的后台" class="sidebar-link">2. 编辑模式-微信订阅号自带的后台</a></li><li class="sidebar-sub-header"><a href="/funkyblog/web/wxpublic/wxpublic1/#_3-开发模式" class="sidebar-link">3. 开发模式</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/funkyblog/web/wxpublic/wxpublic1/#开发模式的流程" class="sidebar-link">开发模式的流程</a></li></ul></li><li class="sidebar-sub-header"><a href="/funkyblog/web/wxpublic/wxpublic1/#_4-express框架" class="sidebar-link">4. Express框架</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/funkyblog/web/wxpublic/wxpublic1/#使用express快速搭建一个服务端" class="sidebar-link">使用Express快速搭建一个服务端</a></li><li class="sidebar-sub-header"><a href="/funkyblog/web/wxpublic/wxpublic1/#express创建项目步骤" class="sidebar-link" style="padding-left:3rem;">Express创建项目步骤</a></li><li class="sidebar-sub-header"><a href="/funkyblog/web/wxpublic/wxpublic1/#express代码结构及作用" class="sidebar-link" style="padding-left:3rem;">Express代码结构及作用</a></li></ul></li><li class="sidebar-sub-header"><a href="/funkyblog/web/wxpublic/wxpublic1/#_5-mongodb与robo3t可视化工具" class="sidebar-link">5. MongoDB与Robo3T可视化工具</a></li><li class="sidebar-sub-header"><a href="/funkyblog/web/wxpublic/wxpublic1/#_6-安装mongoose模块-实现express服务与mongodb数据库链接" class="sidebar-link">6. 安装mongoose模块，实现Express服务与MongoDB数据库链接</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/funkyblog/web/wxpublic/wxpublic1/#安装mongoose连接mongodb" class="sidebar-link">安装mongoose连接mongodb</a></li><li class="sidebar-sub-header"><a href="/funkyblog/web/wxpublic/wxpublic1/#使用mongoose新增数据到mongodb" class="sidebar-link">使用mongoose新增数据到mongodb</a></li></ul></li><li class="sidebar-sub-header"><a href="/funkyblog/web/wxpublic/wxpublic1/#_7-js-sdk鉴权流程" class="sidebar-link">7. JS-SDK鉴权流程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/funkyblog/web/wxpublic/wxpublic1/#公众号js安全域名设置" class="sidebar-link">公众号js安全域名设置</a></li><li class="sidebar-sub-header"><a href="/funkyblog/web/wxpublic/wxpublic1/#ip白名单设置" class="sidebar-link">IP白名单设置</a></li><li class="sidebar-sub-header"><a href="/funkyblog/web/wxpublic/wxpublic1/#基本配置-下的-服务器配置" class="sidebar-link">“基本配置”下的“服务器配置”</a></li><li class="sidebar-sub-header"><a href="/funkyblog/web/wxpublic/wxpublic1/#编写服务器代码-验证服务器配置有效" class="sidebar-link">编写服务器代码，验证服务器配置有效</a></li><li class="sidebar-sub-header"><a href="/funkyblog/web/wxpublic/wxpublic1/#服务端生成signature" class="sidebar-link">服务端生成signature</a></li></ul></li><li class="sidebar-sub-header"><a href="/funkyblog/web/wxpublic/wxpublic1/#参考" class="sidebar-link">参考</a></li><li class="sidebar-sub-header"><a href="/funkyblog/web/wxpublic/wxpublic1/#源码" class="sidebar-link">源码</a></li></ul></li><li><a href="/funkyblog/web/wxpublic/wxpublic2/" class="sidebar-link">2. 微信订阅号二</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p></p><div class="table-of-contents"><ul><li><a href="#_1-公众号类型及基本介绍">1. 公众号类型及基本介绍</a><ul><li><a href="#账号分类">账号分类</a></li><li><a href="#注册个人订阅号">注册个人订阅号</a></li></ul></li><li><a href="#_2-编辑模式-微信订阅号自带的后台">2. 编辑模式-微信订阅号自带的后台</a></li><li><a href="#_3-开发模式">3. 开发模式</a><ul><li><a href="#开发模式的流程">开发模式的流程</a></li></ul></li><li><a href="#_4-express框架">4. Express框架</a><ul><li><a href="#使用express快速搭建一个服务端">使用Express快速搭建一个服务端</a></li></ul></li><li><a href="#_5-mongodb与robo3t可视化工具">5. MongoDB与Robo3T可视化工具</a></li><li><a href="#_6-安装mongoose模块-实现express服务与mongodb数据库链接">6. 安装mongoose模块，实现Express服务与MongoDB数据库链接</a><ul><li><a href="#安装mongoose连接mongodb">安装mongoose连接mongodb</a></li><li><a href="#使用mongoose新增数据到mongodb">使用mongoose新增数据到mongodb</a></li></ul></li><li><a href="#_7-js-sdk鉴权流程">7. JS-SDK鉴权流程</a><ul><li><a href="#公众号js安全域名设置">公众号js安全域名设置</a></li><li><a href="#ip白名单设置">IP白名单设置</a></li><li><a href="#基本配置-下的-服务器配置">“基本配置”下的“服务器配置”</a></li><li><a href="#编写服务器代码-验证服务器配置有效">编写服务器代码，验证服务器配置有效</a></li><li><a href="#服务端生成signature">服务端生成signature</a></li></ul></li><li><a href="#参考">参考</a></li><li><a href="#源码">源码</a></li></ul></div><p></p> <h2 id="_1-公众号类型及基本介绍"><a href="#_1-公众号类型及基本介绍" class="header-anchor">#</a> 1. 公众号类型及基本介绍</h2> <ul><li><a href="https://mp.weixin.qq.com/" target="_blank" rel="noopener noreferrer">微信公众平台<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <h3 id="账号分类"><a href="#账号分类" class="header-anchor">#</a> 账号分类</h3> <p><br><img src="http://funky_hs.gitee.io/imgcloud/funkyblog/web/wx/wxpublic1/1.png" width="600"></p> <h3 id="注册个人订阅号"><a href="#注册个人订阅号" class="header-anchor">#</a> 注册个人订阅号</h3> <p><br><img src="http://funky_hs.gitee.io/imgcloud/funkyblog/web/wx/wxpublic1/2.png" width="600"> <br><img src="http://funky_hs.gitee.io/imgcloud/funkyblog/web/wx/wxpublic1/3.png" width="600"> <br><img src="http://funky_hs.gitee.io/imgcloud/funkyblog/web/wx/wxpublic1/4.png" width="600"> <br><img src="http://funky_hs.gitee.io/imgcloud/funkyblog/web/wx/wxpublic1/5.png" width="600"> <br><img src="http://funky_hs.gitee.io/imgcloud/funkyblog/web/wx/wxpublic1/6.png" width="600"> <br><img src="http://funky_hs.gitee.io/imgcloud/funkyblog/web/wx/wxpublic1/7.png" width="600"> <br><img src="http://funky_hs.gitee.io/imgcloud/funkyblog/web/wx/wxpublic1/8.png" width="600"> <br><img src="http://funky_hs.gitee.io/imgcloud/funkyblog/web/wx/wxpublic1/9.png" width="600"> <br><img src="http://funky_hs.gitee.io/imgcloud/funkyblog/web/wx/wxpublic1/10.png" width="600"></p> <h2 id="_2-编辑模式-微信订阅号自带的后台"><a href="#_2-编辑模式-微信订阅号自带的后台" class="header-anchor">#</a> 2. 编辑模式-微信订阅号自带的后台</h2> <p><br><img src="http://funky_hs.gitee.io/imgcloud/funkyblog/web/wx/wxpublic1/11.png" width="600"></p> <h2 id="_3-开发模式"><a href="#_3-开发模式" class="header-anchor">#</a> 3. 开发模式</h2> <h3 id="开发模式的流程"><a href="#开发模式的流程" class="header-anchor">#</a> 开发模式的流程</h3> <ul><li>微信为我们提供了可以操作的后台界面来管理微信订阅号显示的菜单内容等，编辑界面访问的是微信的服务器</li> <li>用户与微信服务器的关系是多对一的关系，微信用户订阅微信公众号，就可以接收到微信服务器对应的内容</li> <li>微信同时也提供了一种方式，可以使用自己的服务器。用户请求微信服务器，微信服务器将请求转发给我们自己的服务器，然后由我们自己的服务器去作出对应的响应</li> <li>这里引用<a href="https://www.bilibili.com/video/BV1KD4y1d7zD?p=6" target="_blank" rel="noopener noreferrer">教程<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>中的流程图加以说明
<br><img src="http://funky_hs.gitee.io/imgcloud/funkyblog/web/wx/wxpublic1/12.png" width="600"></li></ul> <h2 id="_4-express框架"><a href="#_4-express框架" class="header-anchor">#</a> 4. Express框架</h2> <h3 id="使用express快速搭建一个服务端"><a href="#使用express快速搭建一个服务端" class="header-anchor">#</a> 使用Express快速搭建一个服务端</h3> <ul><li><a href="https://www.expressjs.com.cn/" target="_blank" rel="noopener noreferrer">Express中文网<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://www.expressjs.com.cn/starter/generator.html" target="_blank" rel="noopener noreferrer">Express 应用程序生成器<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <h4 id="express创建项目步骤"><a href="#express创建项目步骤" class="header-anchor">#</a> Express创建项目步骤</h4> <ul><li>安装express生成器：<code>npm i -g express-generator</code></li> <li>查看是否安装express：<code>express -h</code></li> <li>使用express初始化项目结构：<code>express --no-view 项目名称</code></li> <li>在命令行中指定到项目目录下，并安装依赖：<code>npm install</code></li> <li>启动express服务：<code>npm run start</code> <br><img src="http://funky_hs.gitee.io/imgcloud/funkyblog/web/wx/wxpublic1/13.png" width="600"></li></ul> <h4 id="express代码结构及作用"><a href="#express代码结构及作用" class="header-anchor">#</a> Express代码结构及作用</h4> <ul><li>bin/www文件：关于服务启动的文件，设置监听端口号localhost:3000</li> <li>public/： 静态资源存放目录，内部包含image，js，css，html等</li> <li>routes/： 编写服务端接口</li> <li>在app.js中</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 当我们访问`斜杠绝对路径 /images/test.png`的时候，他会帮我们引导到public文件夹中去找对应的静态资源</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'public'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="_5-mongodb与robo3t可视化工具"><a href="#_5-mongodb与robo3t可视化工具" class="header-anchor">#</a> 5. MongoDB与Robo3T可视化工具</h2> <ul><li>下载并安装<a href="https://www.mongodb.com/try/download/community" target="_blank" rel="noopener noreferrer">MongoDB数据库<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>环境</li> <li>指定数据库目录，启动数据库：<code>sudo mongod --dbpath=/Users/Funky/data</code></li> <li>通过上面一步，启动成功以后，使用可视化工具<a href="https://robomongo.org/" target="_blank" rel="noopener noreferrer">Robo3T<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，连接数据库</li> <li>mongodb默认的端口号是：27017
<br><img src="http://funky_hs.gitee.io/imgcloud/funkyblog/web/wx/wxpublic1/14.png" width="600"></li></ul> <h2 id="_6-安装mongoose模块-实现express服务与mongodb数据库链接"><a href="#_6-安装mongoose模块-实现express服务与mongodb数据库链接" class="header-anchor">#</a> 6. 安装mongoose模块，实现Express服务与MongoDB数据库链接</h2> <h3 id="安装mongoose连接mongodb"><a href="#安装mongoose连接mongodb" class="header-anchor">#</a> 安装mongoose连接mongodb</h3> <ul><li>安装mongoose模块，在命令行执行：<code>npm i mongoose</code></li> <li>在my-server项目文件夹下创建db文件夹，在db中创建<code>connect.js</code></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> mongoose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mongoose'</span><span class="token punctuation">)</span>
mongoose<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">'mongodb://127.0.0.1:27017/weixin'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'数据库连接失败'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'数据库连接成功'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><ul><li>在app.js中引入<code>connect.js</code></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> db <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./db/connect'</span><span class="token punctuation">)</span>
</code></pre></div><ul><li>此时重新启动服务：<code>npm start</code>,命令行将打印数据库连接结果</li> <li><a href="http://www.mongoosejs.net/" target="_blank" rel="noopener noreferrer">mongoose中文网<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <h3 id="使用mongoose新增数据到mongodb"><a href="#使用mongoose新增数据到mongodb" class="header-anchor">#</a> 使用mongoose新增数据到mongodb</h3> <ul><li>创建用户模型<code>UserModel.js</code></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> mongoose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mongoose'</span><span class="token punctuation">)</span>

<span class="token keyword">var</span> userSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mongoose<span class="token punctuation">.</span>Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token comment">//表结构对象</span>
    user<span class="token operator">:</span>String<span class="token punctuation">,</span>
    pwd<span class="token operator">:</span>String
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> userModel <span class="token operator">=</span> mongoose<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string">'userModel'</span><span class="token punctuation">,</span>userSchema<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//操作表结构对象的数据模型</span>
<span class="token comment">// 通过模型，才能操作数据</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> userModel<span class="token punctuation">;</span> <span class="token comment">// 将模型导出</span>
</code></pre></div><ul><li>在路由<code>routes/index.js</code>中</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> UserModel <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../db/models/UserModel'</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/reg'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">)</span> <span class="token comment">//接收前端通过post提交的数据</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span>user<span class="token punctuation">,</span>pwd<span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
  <span class="token comment">// 使用mongoose提供的方法，将user与pwd存储至数据库</span>
  <span class="token keyword">new</span> <span class="token class-name">UserModel</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token comment">// 一条具体的数据</span>
    user<span class="token operator">:</span>user<span class="token punctuation">,</span>
    pwd<span class="token operator">:</span>pwd
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>code<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>msg<span class="token operator">:</span><span class="token string">'注册成功'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><ul><li><p>使用postman测试接口
<br><img src="http://funky_hs.gitee.io/imgcloud/funkyblog/web/wx/wxpublic1/15.png" width="600"></p></li> <li><p>使用Robo3T查看插入到数据库中的数据
<br><img src="http://funky_hs.gitee.io/imgcloud/funkyblog/web/wx/wxpublic1/16.png" width="600"></p></li></ul> <h2 id="_7-js-sdk鉴权流程"><a href="#_7-js-sdk鉴权流程" class="header-anchor">#</a> 7. JS-SDK鉴权流程</h2> <ul><li><p>鉴权的意义：微信在开发模式下，提供了许多<a href="https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/JS-SDK.html" target="_blank" rel="noopener noreferrer">api<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p><a href="https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/JS-SDK.html#1" target="_blank" rel="noopener noreferrer">官方-使用JSDSK的步骤<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p>这里引用<a href="https://www.bilibili.com/video/BV1KD4y1d7zD?p=12" target="_blank" rel="noopener noreferrer">教程<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>中的流程图加以说明
<br><img src="http://funky_hs.gitee.io/imgcloud/funkyblog/web/wx/wxpublic1/17.png" width="700"></p></li> <li><p>（1）node服务器请求微信服务器提供的api，获取到<code>access_token</code></p></li> <li><p>（2）node服务器根据<code>access_token</code>，获取到<code>jsapi_ticket</code></p></li> <li><p>（3）node服务器在通过<code>jsapi_ticket</code>，<code>timestamp</code>，<code>nonceStr</code>，<code>url</code>(url是前端传过来的，哪个地址需要使用jssdk api)，生成签名signature</p></li> <li><p>（4）node服务器将<code>timestamp</code>，<code>nonceStr</code>，<code>signature</code>，<code>appId</code>传给前端</p></li> <li><p>（5）前端调用 <code>wx.config()</code>进行鉴权，鉴权成功后，回调到<code>wx.ready</code>中，便可以使用JSSDK的API了</p></li></ul> <h3 id="公众号js安全域名设置"><a href="#公众号js安全域名设置" class="header-anchor">#</a> 公众号js安全域名设置</h3> <ul><li>登录微信公众平台，进入“公众号设置” ==&gt; “功能设置” ==&gt; “JS接口安全域名”</li> <li>设置JS接口安全域名后，公众号开发者可在该域名下调用微信开放的JS接口
<br><img src="http://funky_hs.gitee.io/imgcloud/funkyblog/web/wx/wxpublic1/18.png" width="500"> <br><img src="http://funky_hs.gitee.io/imgcloud/funkyblog/web/wx/wxpublic1/19.png" width="500"></li> <li>将下载下来的<code>MP_verify_dnD9CGfZVm8BV4Hf.txt</code>，存放在<code>my-server/public/</code>文件夹下，同时部署到线上服务器，用来验证域名的</li></ul> <h3 id="ip白名单设置"><a href="#ip白名单设置" class="header-anchor">#</a> IP白名单设置</h3> <ul><li><p>“开发” ==&gt; “基本配置” ==&gt; “开发者密码（AppSecret）”  ==&gt; 启用，然后保存好AppSecret
<br><img src="http://funky_hs.gitee.io/imgcloud/funkyblog/web/wx/wxpublic1/20.png" width="500"></p></li> <li><p>然后在设置<code>IP白名单</code>，通过开发者ID及密码调用获取<code>access_token</code>接口时，需要设置访问来源IP为白名单。</p></li></ul> <h3 id="基本配置-下的-服务器配置"><a href="#基本配置-下的-服务器配置" class="header-anchor">#</a> “基本配置”下的“服务器配置”</h3> <ul><li>验证消息的确来自微信服务器</li></ul> <h3 id="编写服务器代码-验证服务器配置有效"><a href="#编写服务器代码-验证服务器配置有效" class="header-anchor">#</a> 编写服务器代码，验证服务器配置有效</h3> <ul><li>在命令行安装sha1: <code>npm i sha1</code></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> sha1 <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'sha1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 服务器接入验证接口</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/auth'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span><span class="token punctuation">{</span> 
  <span class="token keyword">let</span> <span class="token punctuation">{</span>signature<span class="token punctuation">,</span>timestamp<span class="token punctuation">,</span>nonce<span class="token punctuation">,</span>echostr<span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">;</span>
  <span class="token keyword">let</span> token <span class="token operator">=</span> <span class="token string">'testweixin'</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> array <span class="token operator">=</span> <span class="token punctuation">[</span>timestamp<span class="token punctuation">,</span> nonce<span class="token punctuation">,</span> token<span class="token punctuation">]</span><span class="token punctuation">;</span>
  array<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//字典排序</span>
  <span class="token keyword">let</span> str <span class="token operator">=</span> array<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token keyword">let</span> resultStr <span class="token operator">=</span> <span class="token function">sha1</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//对字符串进行sha1加密</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>resultStr <span class="token operator">===</span> signature<span class="token punctuation">)</span><span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span><span class="token string">'text/plain'</span><span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>echostr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Error!!!!!'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="服务端生成signature"><a href="#服务端生成signature" class="header-anchor">#</a> 服务端生成signature</h3> <ul><li>在命令行安装axios: <code>npm i axios</code></li> <li>utils/sign.js</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> <span class="token punctuation">{</span>appid<span class="token punctuation">,</span>secret<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../config'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> axios <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'axios'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> sha1 <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'sha1'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> ticketModel <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../db/models/ticketModel'</span><span class="token punctuation">)</span>

<span class="token comment">// https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid=APPID&amp;secret=APPSECRET</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getTicket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">//获取ticket的方法函数</span>
    <span class="token keyword">let</span> tik_data <span class="token operator">=</span> <span class="token keyword">await</span> ticketModel<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> access_token <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> ticket <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>tik_data<span class="token punctuation">.</span>length<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">//判断数据库是否存储过ticket</span>
        <span class="token keyword">let</span> t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> tik_data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>token_time<span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>t<span class="token operator">&gt;</span><span class="token number">7000000</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">//是否过期</span>
            <span class="token comment">//重新获取</span>
            <span class="token keyword">await</span> <span class="token function">loadData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'过期后重新获取token'</span><span class="token punctuation">,</span> access_token<span class="token punctuation">)</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'过期后重新获取ticket'</span><span class="token punctuation">,</span> ticket<span class="token punctuation">)</span>
            <span class="token keyword">let</span> <span class="token punctuation">{</span>_id<span class="token punctuation">}</span> <span class="token operator">=</span> tik_data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
            <span class="token keyword">let</span> time <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">await</span> ticketModel<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span>_id<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span> <span class="token comment">//更新数据库中已过期的access_token</span>
                access_token<span class="token punctuation">,</span>
                token_time<span class="token operator">:</span> time<span class="token punctuation">,</span>
                ticket<span class="token punctuation">,</span>
                ticket_time<span class="token operator">:</span> time
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            access_token <span class="token operator">=</span> tik_data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>access_token<span class="token punctuation">;</span>
            ticket <span class="token operator">=</span> tik_data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ticket<span class="token punctuation">;</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'从自己的数据库拿了token'</span><span class="token punctuation">,</span> access_token<span class="token punctuation">)</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'从自己的数据库拿了ticket'</span><span class="token punctuation">,</span> ticket<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token comment">// 重新获取</span>
        <span class="token keyword">await</span> <span class="token function">loadData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> time <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">ticketModel</span><span class="token punctuation">(</span><span class="token punctuation">{</span>  <span class="token comment">//如果是第一次获取access_token，则对数据库进行新增操作</span>
            access_token<span class="token punctuation">,</span>
            token_time<span class="token operator">:</span>time<span class="token punctuation">,</span>
            ticket<span class="token punctuation">,</span>
            ticket_time<span class="token operator">:</span>time
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">loadData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">let</span> tokenUrl <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>appid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;secret=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>secret<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
        <span class="token comment">// console.log(tokenUrl)</span>
        <span class="token keyword">let</span> token_data <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>tokenUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// console.log('token', token_data.data);</span>
        access_token <span class="token operator">=</span> token_data<span class="token punctuation">.</span>data<span class="token punctuation">.</span>access_token<span class="token punctuation">;</span> <span class="token comment">//得到access_token</span>
        <span class="token keyword">let</span> ticketUrl <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://api.weixin.qq.com/cgi-bin/ticket/getticket?access_token=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>access_token<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;type=jsapi</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> ticket_data <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>ticketUrl<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//得到jsapi_ticket</span>
        ticket <span class="token operator">=</span> ticket_data<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ticket
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        access_token<span class="token punctuation">,</span>
        ticket
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> <span class="token function-variable function">createNonceStr</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token comment">//生成随机字符串</span>
    <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">36</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> <span class="token function-variable function">createTimestamp</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">//生成时间戳</span>
    <span class="token keyword">return</span> <span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">''</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> <span class="token function-variable function">row</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">//处理数据格式的方法函数</span>
    <span class="token keyword">var</span> keys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    keys <span class="token operator">=</span> keys<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//字典排序</span>
    <span class="token keyword">var</span> newObj <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    keys<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        newObj<span class="token punctuation">[</span>key<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">var</span> string <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> k <span class="token keyword">in</span> newObj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        string <span class="token operator">+=</span> <span class="token string">'&amp;'</span> <span class="token operator">+</span> k <span class="token operator">+</span> <span class="token string">'='</span> <span class="token operator">+</span> newObj<span class="token punctuation">[</span>k<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
    string <span class="token operator">=</span> string<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> string<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> <span class="token function-variable function">sign</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">//生成signature签名等数据信息的方法</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span>ticket<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getTicket</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
        jsapi_ticket<span class="token operator">:</span>ticket<span class="token punctuation">,</span>
        nonceStr<span class="token operator">:</span><span class="token function">createNonceStr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        timestamp<span class="token operator">:</span><span class="token function">createTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        url
    <span class="token punctuation">}</span>
    <span class="token keyword">var</span> str <span class="token operator">=</span> <span class="token function">row</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> signature <span class="token operator">=</span> <span class="token function">sha1</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//生成签名</span>
    obj<span class="token punctuation">.</span>signature <span class="token operator">=</span> signature<span class="token punctuation">;</span>
    obj<span class="token punctuation">.</span>appId <span class="token operator">=</span> appid<span class="token punctuation">;</span>
    <span class="token comment">// 1，参与签名的字段包括noncestr（随机字符串）, 有效的jsapi_ticket, timestamp（时间戳）, url（当前网页的URL，不包含#及其后面部分） 。</span>
    <span class="token comment">// 2，对所有待签名参数按照字段名的ASCII 码从小到大排序（字典序）后，</span>
    <span class="token comment">// 3，使用URL键值对的格式（即key1 = value1 &amp; key2=value2…）拼接成字符串string1。这里需要注意的是所有参数名均为小写字符。</span>
    <span class="token comment">// 4,对string1作sha1加密，字段名和字段值都采用原始值，不进行URL 转义。</span>
    <span class="token keyword">return</span> obj<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    sign<span class="token punctuation">,</span>
    getTicket
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="参考"><a href="#参考" class="header-anchor">#</a> 参考</h2> <ul><li><a href="https://www.bilibili.com/video/BV1KD4y1d7zD" target="_blank" rel="noopener noreferrer">2020微信公众号开发（零基础全面系统教程）<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://www.bilibili.com/video/BV1nb411P7c9" target="_blank" rel="noopener noreferrer">微信公众号开发实战<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <h2 id="源码"><a href="#源码" class="header-anchor">#</a> 源码</h2> <ul><li><a href="https://github.com/funkyHS/wxpublic" target="_blank" rel="noopener noreferrer">源码<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/funkyblog/web/vue/maizuo/4-maizuo/" class="prev">
        【4. 状态管理机制vuex】
      </a></span> <span class="next"><a href="/funkyblog/web/wxpublic/wxpublic2/">
        2. 微信订阅号二
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/funkyblog/assets/js/app.a24b3efd.js" defer></script><script src="/funkyblog/assets/js/2.3aea1f50.js" defer></script><script src="/funkyblog/assets/js/126.8eec9a18.js" defer></script>
  </body>
</html>
