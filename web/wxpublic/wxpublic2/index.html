<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>2. 微信订阅号二 | Funky&#39;s blog</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/funkyblog/logo.jpg">
    <meta name="description" content="Funky的个人技术博客">
    
    <link rel="preload" href="/funkyblog/assets/css/0.styles.c5671824.css" as="style"><link rel="preload" href="/funkyblog/assets/js/app.a24b3efd.js" as="script"><link rel="preload" href="/funkyblog/assets/js/2.3aea1f50.js" as="script"><link rel="preload" href="/funkyblog/assets/js/127.d14ed3d3.js" as="script"><link rel="prefetch" href="/funkyblog/assets/js/10.fdb72551.js"><link rel="prefetch" href="/funkyblog/assets/js/100.322ef7c3.js"><link rel="prefetch" href="/funkyblog/assets/js/101.7adabe50.js"><link rel="prefetch" href="/funkyblog/assets/js/102.b672d5b4.js"><link rel="prefetch" href="/funkyblog/assets/js/103.cbd5f57f.js"><link rel="prefetch" href="/funkyblog/assets/js/104.98c6bdcb.js"><link rel="prefetch" href="/funkyblog/assets/js/105.51f7efcb.js"><link rel="prefetch" href="/funkyblog/assets/js/106.bcdfddc5.js"><link rel="prefetch" href="/funkyblog/assets/js/107.000a9752.js"><link rel="prefetch" href="/funkyblog/assets/js/108.92133c7f.js"><link rel="prefetch" href="/funkyblog/assets/js/109.249e3002.js"><link rel="prefetch" href="/funkyblog/assets/js/11.8d7a0728.js"><link rel="prefetch" href="/funkyblog/assets/js/110.a116e6e3.js"><link rel="prefetch" href="/funkyblog/assets/js/111.5d78ef12.js"><link rel="prefetch" href="/funkyblog/assets/js/112.2c266219.js"><link rel="prefetch" href="/funkyblog/assets/js/113.480d3824.js"><link rel="prefetch" href="/funkyblog/assets/js/114.fa1b4ab2.js"><link rel="prefetch" href="/funkyblog/assets/js/115.d65cb78a.js"><link rel="prefetch" href="/funkyblog/assets/js/116.33a2e878.js"><link rel="prefetch" href="/funkyblog/assets/js/117.bbd07ef4.js"><link rel="prefetch" href="/funkyblog/assets/js/118.0dedd5d9.js"><link rel="prefetch" href="/funkyblog/assets/js/119.5a13d359.js"><link rel="prefetch" href="/funkyblog/assets/js/12.84a022d2.js"><link rel="prefetch" href="/funkyblog/assets/js/120.6d8406bc.js"><link rel="prefetch" href="/funkyblog/assets/js/121.1535eb29.js"><link rel="prefetch" href="/funkyblog/assets/js/122.25226b03.js"><link rel="prefetch" href="/funkyblog/assets/js/123.00d7c304.js"><link rel="prefetch" href="/funkyblog/assets/js/124.16802c94.js"><link rel="prefetch" href="/funkyblog/assets/js/125.541331b4.js"><link rel="prefetch" href="/funkyblog/assets/js/126.8eec9a18.js"><link rel="prefetch" href="/funkyblog/assets/js/13.fe7b989e.js"><link rel="prefetch" href="/funkyblog/assets/js/14.06c2893e.js"><link rel="prefetch" href="/funkyblog/assets/js/15.7db30254.js"><link rel="prefetch" href="/funkyblog/assets/js/16.f5c8a3a0.js"><link rel="prefetch" href="/funkyblog/assets/js/17.ee25e8b2.js"><link rel="prefetch" href="/funkyblog/assets/js/18.138ba97b.js"><link rel="prefetch" href="/funkyblog/assets/js/19.7b046ac4.js"><link rel="prefetch" href="/funkyblog/assets/js/20.93aa8f6a.js"><link rel="prefetch" href="/funkyblog/assets/js/21.b422e4c4.js"><link rel="prefetch" href="/funkyblog/assets/js/22.4b4fa0d1.js"><link rel="prefetch" href="/funkyblog/assets/js/23.3135691d.js"><link rel="prefetch" href="/funkyblog/assets/js/24.5ed690d9.js"><link rel="prefetch" href="/funkyblog/assets/js/25.599c60f6.js"><link rel="prefetch" href="/funkyblog/assets/js/26.9388b7c2.js"><link rel="prefetch" href="/funkyblog/assets/js/27.a17039b1.js"><link rel="prefetch" href="/funkyblog/assets/js/28.51a65ac9.js"><link rel="prefetch" href="/funkyblog/assets/js/29.ca8f9960.js"><link rel="prefetch" href="/funkyblog/assets/js/3.90f0fac9.js"><link rel="prefetch" href="/funkyblog/assets/js/30.c93ba89f.js"><link rel="prefetch" href="/funkyblog/assets/js/31.1739efda.js"><link rel="prefetch" href="/funkyblog/assets/js/32.3d6133c5.js"><link rel="prefetch" href="/funkyblog/assets/js/33.ea1b693d.js"><link rel="prefetch" href="/funkyblog/assets/js/34.f5f68409.js"><link rel="prefetch" href="/funkyblog/assets/js/35.fe8276f9.js"><link rel="prefetch" href="/funkyblog/assets/js/36.7dfbbc31.js"><link rel="prefetch" href="/funkyblog/assets/js/37.38292e55.js"><link rel="prefetch" href="/funkyblog/assets/js/38.814bd863.js"><link rel="prefetch" href="/funkyblog/assets/js/39.ff4fbd9f.js"><link rel="prefetch" href="/funkyblog/assets/js/4.bf89a90b.js"><link rel="prefetch" href="/funkyblog/assets/js/40.b78c54dc.js"><link rel="prefetch" href="/funkyblog/assets/js/41.f17fe040.js"><link rel="prefetch" href="/funkyblog/assets/js/42.83583d5d.js"><link rel="prefetch" href="/funkyblog/assets/js/43.deed3fdd.js"><link rel="prefetch" href="/funkyblog/assets/js/44.8033ac93.js"><link rel="prefetch" href="/funkyblog/assets/js/45.78c09822.js"><link rel="prefetch" href="/funkyblog/assets/js/46.dc92e91d.js"><link rel="prefetch" href="/funkyblog/assets/js/47.58c20506.js"><link rel="prefetch" href="/funkyblog/assets/js/48.03e8e813.js"><link rel="prefetch" href="/funkyblog/assets/js/49.51f46791.js"><link rel="prefetch" href="/funkyblog/assets/js/5.f6f2e860.js"><link rel="prefetch" href="/funkyblog/assets/js/50.d62f902a.js"><link rel="prefetch" href="/funkyblog/assets/js/51.2f77c15c.js"><link rel="prefetch" href="/funkyblog/assets/js/52.14d3dba9.js"><link rel="prefetch" href="/funkyblog/assets/js/53.9598cf79.js"><link rel="prefetch" href="/funkyblog/assets/js/54.669e4f25.js"><link rel="prefetch" href="/funkyblog/assets/js/55.aeb878b8.js"><link rel="prefetch" href="/funkyblog/assets/js/56.23f25070.js"><link rel="prefetch" href="/funkyblog/assets/js/57.f048233b.js"><link rel="prefetch" href="/funkyblog/assets/js/58.f3967f69.js"><link rel="prefetch" href="/funkyblog/assets/js/59.62f0670e.js"><link rel="prefetch" href="/funkyblog/assets/js/6.6d922041.js"><link rel="prefetch" href="/funkyblog/assets/js/60.016ba18c.js"><link rel="prefetch" href="/funkyblog/assets/js/61.b5d2cff8.js"><link rel="prefetch" href="/funkyblog/assets/js/62.ac5f87fe.js"><link rel="prefetch" href="/funkyblog/assets/js/63.d9a60137.js"><link rel="prefetch" href="/funkyblog/assets/js/64.b591a667.js"><link rel="prefetch" href="/funkyblog/assets/js/65.e768c8e9.js"><link rel="prefetch" href="/funkyblog/assets/js/66.5f46813d.js"><link rel="prefetch" href="/funkyblog/assets/js/67.02b3f46c.js"><link rel="prefetch" href="/funkyblog/assets/js/68.676ba975.js"><link rel="prefetch" href="/funkyblog/assets/js/69.e031cc98.js"><link rel="prefetch" href="/funkyblog/assets/js/7.7a61e41b.js"><link rel="prefetch" href="/funkyblog/assets/js/70.94a805bd.js"><link rel="prefetch" href="/funkyblog/assets/js/71.281fda5b.js"><link rel="prefetch" href="/funkyblog/assets/js/72.290763cf.js"><link rel="prefetch" href="/funkyblog/assets/js/73.21b036b0.js"><link rel="prefetch" href="/funkyblog/assets/js/74.df7e87b8.js"><link rel="prefetch" href="/funkyblog/assets/js/75.a73c1199.js"><link rel="prefetch" href="/funkyblog/assets/js/76.44658040.js"><link rel="prefetch" href="/funkyblog/assets/js/77.bd56a926.js"><link rel="prefetch" href="/funkyblog/assets/js/78.09a51bc3.js"><link rel="prefetch" href="/funkyblog/assets/js/79.cb143284.js"><link rel="prefetch" href="/funkyblog/assets/js/8.708c7e46.js"><link rel="prefetch" href="/funkyblog/assets/js/80.f134bc8b.js"><link rel="prefetch" href="/funkyblog/assets/js/81.12483621.js"><link rel="prefetch" href="/funkyblog/assets/js/82.e41901b3.js"><link rel="prefetch" href="/funkyblog/assets/js/83.5c039041.js"><link rel="prefetch" href="/funkyblog/assets/js/84.c4c06788.js"><link rel="prefetch" href="/funkyblog/assets/js/85.bced8698.js"><link rel="prefetch" href="/funkyblog/assets/js/86.5315ed66.js"><link rel="prefetch" href="/funkyblog/assets/js/87.4ea61a5c.js"><link rel="prefetch" href="/funkyblog/assets/js/88.aa62f043.js"><link rel="prefetch" href="/funkyblog/assets/js/89.0eb25b80.js"><link rel="prefetch" href="/funkyblog/assets/js/9.e076e28d.js"><link rel="prefetch" href="/funkyblog/assets/js/90.7f136876.js"><link rel="prefetch" href="/funkyblog/assets/js/91.12c27e63.js"><link rel="prefetch" href="/funkyblog/assets/js/92.e2ffad27.js"><link rel="prefetch" href="/funkyblog/assets/js/93.a08e3a15.js"><link rel="prefetch" href="/funkyblog/assets/js/94.977d3ede.js"><link rel="prefetch" href="/funkyblog/assets/js/95.f8e1328d.js"><link rel="prefetch" href="/funkyblog/assets/js/96.c119e0f7.js"><link rel="prefetch" href="/funkyblog/assets/js/97.e483280d.js"><link rel="prefetch" href="/funkyblog/assets/js/98.0f1eb7a4.js"><link rel="prefetch" href="/funkyblog/assets/js/99.7813329f.js">
    <link rel="stylesheet" href="/funkyblog/assets/css/0.styles.c5671824.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/funkyblog/" class="home-link router-link-active"><img src="/funkyblog/logo.jpg" alt="Funky's blog" class="logo"> <span class="site-name can-hide">Funky's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/funkyblog/" class="nav-link">
  Guide
</a></div><div class="nav-item"><a href="/funkyblog/flutter/" class="nav-link">
  Flutter
</a></div><div class="nav-item"><a href="/funkyblog/server/" class="nav-link">
  Server
</a></div><div class="nav-item"><a href="/funkyblog/web/" class="nav-link router-link-active">
  Web
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/funkyblog/" class="nav-link">
  Guide
</a></div><div class="nav-item"><a href="/funkyblog/flutter/" class="nav-link">
  Flutter
</a></div><div class="nav-item"><a href="/funkyblog/server/" class="nav-link">
  Server
</a></div><div class="nav-item"><a href="/funkyblog/web/" class="nav-link router-link-active">
  Web
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Vue</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Vue项目-电影卖座</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>微信公众平台</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/funkyblog/web/wxpublic/wxpublic1/" class="sidebar-link">1. 微信订阅号一</a></li><li><a href="/funkyblog/web/wxpublic/wxpublic2/" aria-current="page" class="active sidebar-link">2. 微信订阅号二</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/funkyblog/web/wxpublic/wxpublic2/#_1-微信公众号测试号接口使用" class="sidebar-link">1. 微信公众号测试号接口使用</a></li><li class="sidebar-sub-header"><a href="/funkyblog/web/wxpublic/wxpublic2/#_2-微信公众号开发模式核心流程与步骤" class="sidebar-link">2. 微信公众号开发模式核心流程与步骤</a></li><li class="sidebar-sub-header"><a href="/funkyblog/web/wxpublic/wxpublic2/#_3-微信服务器如何知道开发者服务器是哪个-ngrok内网穿透" class="sidebar-link">3. 微信服务器如何知道开发者服务器是哪个--Ngrok内网穿透</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/funkyblog/web/wxpublic/wxpublic2/#在-接口配置信息-中填写合法的url-不能使用localhost" class="sidebar-link">在“接口配置信息”中填写合法的URL，不能使用localhost</a></li><li class="sidebar-sub-header"><a href="/funkyblog/web/wxpublic/wxpublic2/#ngrok内网穿透-将内网对应端口号的服务映射成外网的网址" class="sidebar-link">Ngrok内网穿透--将内网对应端口号的服务映射成外网的网址</a></li><li class="sidebar-sub-header"><a href="/funkyblog/web/wxpublic/wxpublic2/#填写-接口配置信息" class="sidebar-link">填写“接口配置信息”</a></li></ul></li><li class="sidebar-sub-header"><a href="/funkyblog/web/wxpublic/wxpublic2/#_4-开发者服务器-验证消息是否来自于微信服务器" class="sidebar-link">4. 开发者服务器--验证消息是否来自于微信服务器</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/funkyblog/web/wxpublic/wxpublic2/#新建config-index-js定义配置项" class="sidebar-link">新建config/index.js定义配置项</a></li><li class="sidebar-sub-header"><a href="/funkyblog/web/wxpublic/wxpublic2/#在中间件routes-index-js中添加-auth响应-用来验证开发者服务器有效性" class="sidebar-link">在中间件routes/index.js中添加/auth响应，用来验证开发者服务器有效性</a></li><li class="sidebar-sub-header"><a href="/funkyblog/web/wxpublic/wxpublic2/#在app-js中使用中间件" class="sidebar-link">在app.js中使用中间件</a></li></ul></li><li class="sidebar-sub-header"><a href="/funkyblog/web/wxpublic/wxpublic2/#_5-获取access-token" class="sidebar-link">5. 获取Access token</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/funkyblog/web/wxpublic/wxpublic2/#在-wechat-wechat-js中编写代码" class="sidebar-link">在/wechat/wechat.js中编写代码</a></li></ul></li><li class="sidebar-sub-header"><a href="/funkyblog/web/wxpublic/wxpublic2/#_6-获取用户发送的消息以及回复用户" class="sidebar-link">6. 获取用户发送的消息以及回复用户</a></li><li class="sidebar-sub-header"><a href="/funkyblog/web/wxpublic/wxpublic2/#_7-创建-删除自定义菜单" class="sidebar-link">7. 创建/删除自定义菜单</a></li><li class="sidebar-sub-header"><a href="/funkyblog/web/wxpublic/wxpublic2/#_8-微信网页开发" class="sidebar-link">8. 微信网页开发</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/funkyblog/web/wxpublic/wxpublic2/#获取jsapi-ticket" class="sidebar-link">获取jsapi_ticket</a></li><li class="sidebar-sub-header"><a href="/funkyblog/web/wxpublic/wxpublic2/#使用js-api方法" class="sidebar-link">使用JS-API方法</a></li></ul></li><li class="sidebar-sub-header"><a href="/funkyblog/web/wxpublic/wxpublic2/#参考" class="sidebar-link">参考</a></li><li class="sidebar-sub-header"><a href="/funkyblog/web/wxpublic/wxpublic2/#源码" class="sidebar-link">源码</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p></p><div class="table-of-contents"><ul><li><a href="#_1-微信公众号测试号接口使用">1. 微信公众号测试号接口使用</a></li><li><a href="#_2-微信公众号开发模式核心流程与步骤">2. 微信公众号开发模式核心流程与步骤</a></li><li><a href="#_3-微信服务器如何知道开发者服务器是哪个-ngrok内网穿透">3. 微信服务器如何知道开发者服务器是哪个--Ngrok内网穿透</a><ul><li><a href="#在-接口配置信息-中填写合法的url-不能使用localhost">在“接口配置信息”中填写合法的URL，不能使用localhost</a></li><li><a href="#ngrok内网穿透-将内网对应端口号的服务映射成外网的网址">Ngrok内网穿透--将内网对应端口号的服务映射成外网的网址</a></li><li><a href="#填写-接口配置信息">填写“接口配置信息”</a></li></ul></li><li><a href="#_4-开发者服务器-验证消息是否来自于微信服务器">4. 开发者服务器--验证消息是否来自于微信服务器</a><ul><li><a href="#新建-config-index-js-定义配置项">新建config/index.js定义配置项</a></li><li><a href="#在中间件-routes-index-js-中添加-auth-响应-用来验证开发者服务器有效性">在中间件routes/index.js中添加/auth响应，用来验证开发者服务器有效性</a></li><li><a href="#在app-js中使用中间件">在app.js中使用中间件</a></li></ul></li><li><a href="#_5-获取access-token">5. 获取Access token</a><ul><li><a href="#在-wechat-wechat-js-中编写代码">在/wechat/wechat.js中编写代码</a></li></ul></li><li><a href="#_6-获取用户发送的消息以及回复用户">6. 获取用户发送的消息以及回复用户</a></li><li><a href="#_7-创建-删除自定义菜单">7. 创建/删除自定义菜单</a></li><li><a href="#_8-微信网页开发">8. 微信网页开发</a><ul><li><a href="#获取-jsapi-ticket">获取jsapi_ticket</a></li><li><a href="#使用js-api方法">使用JS-API方法</a></li></ul></li><li><a href="#参考">参考</a></li><li><a href="#源码">源码</a></li></ul></div><p></p> <h2 id="_1-微信公众号测试号接口使用"><a href="#_1-微信公众号测试号接口使用" class="header-anchor">#</a> 1. 微信公众号测试号接口使用</h2> <ul><li><a href="https://www.bilibili.com/video/BV1nb411P7c9?p=4&amp;spm_id_from=pageDriver" target="_blank" rel="noopener noreferrer">学习链接<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>进入测试账号入口：登录公众号后台 ==&gt; “开发” ==&gt; “开发者工具” ==&gt; “公众平台测试账号” ==&gt; 扫码后就可以进入到测试号管理页面
<br><img src="http://funky_hs.gitee.io/imgcloud/funkyblog/web/wx/wxpublic2/21.png" width="600"></li></ul> <h2 id="_2-微信公众号开发模式核心流程与步骤"><a href="#_2-微信公众号开发模式核心流程与步骤" class="header-anchor">#</a> 2. 微信公众号开发模式核心流程与步骤</h2> <ul><li>流程：用户 &lt;=&gt; 微信服务器 &lt;=&gt; 开发者服务器
<ul><li>用户发送消息给微信服务器，微信服务器将消息转发给开发者服务器，开发者服务器作出响应，给微信服务器，微信服务器在将响应给到用户</li> <li>整个过程中，开发者不直接与用户接触</li> <li>微信服务器怎么将用户的信息转发到正确的开发者服务器上 -- 通过设置接口配置信息</li> <li>开发者服务器怎么验证消息是来自微信服务器 -- 对应的鉴定方式</li></ul></li></ul> <div class="custom-block tip"><p class="custom-block-title">微信服务器知道开发者服务器是哪个</p> <ul><li>测试号管理页面上填写url开发者服务器地址
<ul><li>使用ngrok 内网穿透 将本地端口号开启的服务映射成外网跨域访问的一个网址</li> <li>ngrok http 3000</li></ul></li> <li>填写token
<ul><li>参与微信签名加密的一个参数</li></ul></li></ul></div> <div class="custom-block tip"><p class="custom-block-title">开发者服务器 - 验证消息是否来自于微信服务器</p> <ul><li>目的：计算得出signature微信加密签名，和微信传递过来的signature进行对比，如果一样，说明消息来自于微信服务器，如果不一样，说明不是微信服务器发送的消息</li> <li>具体步骤：
<ul><li>（1）将参与微信加密签名的三个参数（timestamp，nonce，token）按照字典序排序并组合在一起形成一个数组</li> <li>（2）将数组里所有参数拼接成一个字符串，进行sha1加密</li> <li>（3）加密完成就生成一个signature，和微信发送过来的进行对比，
如果一样，说明消息来自于微信服务器，返回echostr给微信服务器。
如果不一样，说明不是微信服务器发送的消息，返回error</li></ul></li></ul></div> <h2 id="_3-微信服务器如何知道开发者服务器是哪个-ngrok内网穿透"><a href="#_3-微信服务器如何知道开发者服务器是哪个-ngrok内网穿透" class="header-anchor">#</a> 3. 微信服务器如何知道开发者服务器是哪个--Ngrok内网穿透</h2> <h3 id="在-接口配置信息-中填写合法的url-不能使用localhost"><a href="#在-接口配置信息-中填写合法的url-不能使用localhost" class="header-anchor">#</a> 在“接口配置信息”中填写合法的URL，不能使用localhost</h3> <p><br><img src="http://funky_hs.gitee.io/imgcloud/funkyblog/web/wx/wxpublic2/22.png" width="600"></p> <h3 id="ngrok内网穿透-将内网对应端口号的服务映射成外网的网址"><a href="#ngrok内网穿透-将内网对应端口号的服务映射成外网的网址" class="header-anchor">#</a> Ngrok内网穿透--将内网对应端口号的服务映射成外网的网址</h3> <ul><li><a href="https://ngrok.com/" target="_blank" rel="noopener noreferrer">Ngrok下载<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>下载后，可以放在任意位置，我这里直接放在用户目录下
<br><img src="http://funky_hs.gitee.io/imgcloud/funkyblog/web/wx/wxpublic2/23.png" width="600"></li> <li>在命令行执行：<code>./ngrok http 3000</code>，就可以获取到外网地址(注意：每次运行，网址都会发生变化)
<br><img src="http://funky_hs.gitee.io/imgcloud/funkyblog/web/wx/wxpublic2/24.png" width="600"></li></ul> <h3 id="填写-接口配置信息"><a href="#填写-接口配置信息" class="header-anchor">#</a> 填写“接口配置信息”</h3> <p><br><img src="http://funky_hs.gitee.io/imgcloud/funkyblog/web/wx/wxpublic2/25.png" width="600"></p> <h2 id="_4-开发者服务器-验证消息是否来自于微信服务器"><a href="#_4-开发者服务器-验证消息是否来自于微信服务器" class="header-anchor">#</a> 4. 开发者服务器--验证消息是否来自于微信服务器</h2> <h3 id="新建config-index-js定义配置项"><a href="#新建config-index-js定义配置项" class="header-anchor">#</a> 新建<code>config/index.js</code>定义配置项</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 定义配置项,填写固定的值</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    token<span class="token operator">:</span> <span class="token string">&quot;testweixin&quot;</span><span class="token punctuation">,</span>
    appID<span class="token operator">:</span> <span class="token string">&quot;wxf0aac87977b3f5c7&quot;</span><span class="token punctuation">,</span>
    appsecret<span class="token operator">:</span> <span class="token string">&quot;fddcfafe8e1e316aa7667cc8db3fb3e7&quot;</span><span class="token punctuation">,</span>
    mongoip<span class="token operator">:</span><span class="token string">'127.0.0.1:27017'</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="在中间件routes-index-js中添加-auth响应-用来验证开发者服务器有效性"><a href="#在中间件routes-index-js中添加-auth响应-用来验证开发者服务器有效性" class="header-anchor">#</a> 在中间件<code>routes/index.js</code>中添加<code>/auth</code>响应，用来验证开发者服务器有效性</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/*
    验证服务器有效性模块
*/</span>
<span class="token keyword">const</span> sha1 <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'sha1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../config'</span><span class="token punctuation">)</span>

<span class="token comment">// 服务器接入验证接口</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/auth'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span><span class="token punctuation">{</span> 
  <span class="token comment">// 微信服务器提交的参数</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;收到参数=&gt;&quot;</span><span class="token punctuation">,</span>req<span class="token punctuation">.</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/*
      signature=4fd2841dbeb325c03b9d6bc6ea2d25a75b82359c&amp;  // 微信的加密签名
      echostr=5925562708760952766&amp; // 微信的随机字符串
      timestamp=1618242232&amp; // 微信的发送请求时间戳
      nonce=1859101214 // 微信的随机数字
  */</span>

  <span class="token comment">// 1. 将参与微信加密签名的三个参数（timestamp，nonce，token）按照字典序排序并组合在一起形成一个数组</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span>signature<span class="token punctuation">,</span>timestamp<span class="token punctuation">,</span>nonce<span class="token punctuation">,</span>echostr<span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">;</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span>token<span class="token punctuation">}</span> <span class="token operator">=</span> config<span class="token punctuation">;</span>
  <span class="token keyword">let</span> array <span class="token operator">=</span> <span class="token punctuation">[</span>timestamp<span class="token punctuation">,</span> nonce<span class="token punctuation">,</span> token<span class="token punctuation">]</span><span class="token punctuation">;</span>
  array<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//字典排序</span>

  <span class="token comment">// 2. 将数组里所有参数拼接成一个字符串，进行sha1加密</span>
  <span class="token keyword">let</span> str <span class="token operator">=</span> array<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token keyword">let</span> resultStr <span class="token operator">=</span> <span class="token function">sha1</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 3. 加密完成就生成一个signature，和微信发送过来的进行对比</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>resultStr <span class="token operator">===</span> signature<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">// 3.1 如果一样，说明消息来自于微信服务器，返回echostr给微信服务器。</span>
      res<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span><span class="token string">'text/plain'</span><span class="token punctuation">)</span>
      res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>echostr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
      <span class="token comment">// 3.2 如果不一样，说明不是微信服务器发送的消息，返回error</span>
      res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Error!!!!!'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="在app-js中使用中间件"><a href="#在app-js中使用中间件" class="header-anchor">#</a> 在app.js中使用中间件</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 导入中间件</span>
<span class="token keyword">var</span> indexRouter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./routes/index'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> indexRouter<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="_5-获取access-token"><a href="#_5-获取access-token" class="header-anchor">#</a> 5. 获取Access token</h2> <ul><li><a href="https://developers.weixin.qq.com/doc/offiaccount/Basic_Information/Get_access_token.html" target="_blank" rel="noopener noreferrer">Access token开发文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>access_token是公众号的全局唯一接口调用凭据，公众号调用各接口时都需使用access_token。</li> <li>开发者需要进行妥善保存。access_token的存储至少要保留512个字符空间。</li> <li>access_token的有效期目前为2个小时，需定时刷新，重复获取将导致上次获取的access_token失效。</li></ul> <h3 id="在-wechat-wechat-js中编写代码"><a href="#在-wechat-wechat-js中编写代码" class="header-anchor">#</a> 在<code>/wechat/wechat.js</code>中编写代码</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/*
access_token: 公众号的全局唯一接口调用凭据，公众号调用各接口时都需使用access_token。
    特点：1. 唯一的
         2. 有效期为2小时，提前5分钟请求
         3. 接口权限，每天2000次
    请求地址：
        https请求方式: GET 
        地址：https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid=APPID&amp;secret=APPSECRET
    设计思路：
        1. 首次本地没有，发送请求获取access_token,保存下来（本地文件）
        2. 第二次或者以后：先去本地读取文件，判断是否过期。
            如果过期，重新请求access_token，保存并覆盖之前的文件
            如果没有过期，可以直接使用
*/</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span>appID<span class="token punctuation">,</span> appsecret<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../config'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> axios <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'axios'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>writeFile<span class="token punctuation">,</span> readFile<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span> <span class="token comment">// 引入fs模块</span>

<span class="token keyword">class</span> <span class="token class-name">Wechat</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token comment">// 用来获取 access_token</span>
    <span class="token keyword">async</span> <span class="token function">getAccessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> tokenUrl <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>appID<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;secret=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>appsecret<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> token_data <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>tokenUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> res <span class="token operator">=</span> token_data<span class="token punctuation">.</span>data
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
        <span class="token comment">/*
            { 
                access_token: '44_NWgbQD5ls7aXexxmjDQouhidMBfW2yPmk_7g4xqACLebEX9qcQeP-AOYlnj4MBaY9FY0x3FMqaTZAE0A3GHD3xcIj9xIdtqr4YCTh-UpagKXI1s85vwHJHum0PXggShqjABLiCuydLYFCtddJCPjAGAEXK',
                expires_in: 7200 
            }
        */</span>
        <span class="token comment">// 设置access_token的过期时间</span>
        res<span class="token punctuation">.</span>expires_in <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>expires_in <span class="token operator">-</span> <span class="token number">300</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> res
    <span class="token punctuation">}</span>

    <span class="token comment">// 用来保存access_token</span>
    <span class="token function">saveAccessToken</span><span class="token punctuation">(</span><span class="token parameter">accessToken</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 将对象转化为json字符串</span>
        accessToken <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>accessToken<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">reslove<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">writeFile</span><span class="token punctuation">(</span><span class="token string">'./accessToken.txt'</span><span class="token punctuation">,</span>accessToken<span class="token punctuation">,</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'文件保存成功'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">reslove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">&quot;saveAccessToken方法出了问题：&quot;</span> <span class="token operator">+</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 用来读取access_token</span>
    <span class="token function">readAccessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">reslove<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'./accessToken.txt'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span>data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'文件读取成功'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    data <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
                    <span class="token function">reslove</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">&quot;readAccessToken方法出了问题：&quot;</span> <span class="token operator">+</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 用来检测access_token是否有效</span>
    <span class="token function">isValidAccessToken</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 检测传入的参数是否是有效的</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>data <span class="token operator">||</span> <span class="token operator">!</span>data<span class="token punctuation">.</span>access_token <span class="token operator">||</span> <span class="token operator">!</span>data<span class="token punctuation">.</span>expires_in<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 检测access_token是否在有效期内</span>
        <span class="token keyword">return</span> data<span class="token punctuation">.</span>expires_in <span class="token operator">&gt;</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 最终方法：用来获取没有过期的access_token</span>
    <span class="token function">fetchAccessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>access_token <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>expires_in <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isValidAccessToken</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 说明之前保存过access_token，并且它是有效的，直接使用</span>
            <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                access_token<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>access_token<span class="token punctuation">,</span>
                expires_in<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>expires_in
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">readAccessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token comment">// 本地有文件,判断access_token是否过期</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isValidAccessToken</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 过期了</span>
                    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getAccessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">saveAccessToken</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
                    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token comment">// 本地没有文件</span>
                <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getAccessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">saveAccessToken</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
                <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token comment">// 将access_token挂载到this上</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>access_token <span class="token operator">=</span> res<span class="token punctuation">.</span>access_token<span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>expires_in <span class="token operator">=</span> res<span class="token punctuation">.</span>expires_in<span class="token punctuation">;</span>
                <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token comment">// 模拟测试</span>
<span class="token keyword">const</span> w <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Wechat</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
w<span class="token punctuation">.</span><span class="token function">fetchAccessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;这里获取到accessToken：&quot;</span><span class="token punctuation">,</span>res<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;获取accessToken失败：&quot;</span><span class="token punctuation">,</span>err<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><ul><li>执行上面的代码，在同级目录下生成了<code>accessToken.txt</code>文件
<br><img src="http://funky_hs.gitee.io/imgcloud/funkyblog/web/wx/wxpublic2/26.png" width="600"></li></ul> <h2 id="_6-获取用户发送的消息以及回复用户"><a href="#_6-获取用户发送的消息以及回复用户" class="header-anchor">#</a> 6. 获取用户发送的消息以及回复用户</h2> <ul><li><p><code>微信服务器</code>会将用户发送的数据以POST请求的方式转发到<code>开发者服务器</code>上</p></li> <li><p><a href="https://developers.weixin.qq.com/doc/offiaccount/Message_Management/Passive_user_reply_message.html" target="_blank" rel="noopener noreferrer">被动回复消息说明文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p>在<code>测试号管理</code>页面中，使用微信扫描关注<code>测试号二维码</code>,然后发送消息到测试号，此时<code>开发者服务器</code>就会收到<code>微信服务器</code>发送的post请求，打印微信服务器发送过来的的请求参数（signature，timestamp，nonce，openid）
<br><img src="http://funky_hs.gitee.io/imgcloud/funkyblog/web/wx/wxpublic2/27.png" width="500"></p></li> <li><p>实现代码：在<code>/routes/index.js</code>路由中，添加<code>/auth</code>post请求方式</p></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> getUserDataAsync<span class="token punctuation">,</span> parseXMLAsync<span class="token punctuation">,</span> formatMessage <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../wechat/tool'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> template <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../wechat/template'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> reply <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../wechat/reply'</span><span class="token punctuation">)</span>

<span class="token comment">// 微信服务器会将用户发送的数据以POST请求的方式转发到开发者服务器上</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/auth'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 微信服务器提交的参数</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;post收到参数=&gt;&quot;</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/*
    { signature: 'acd46a5f8a2bdac8068c075b8707d438df21538e',
      timestamp: '1618300337',
      nonce: '1255424088',
      openid: 'ojKF_6lcSp8cLByurJlNJElwjCjg' }
  */</span>

  <span class="token keyword">let</span> <span class="token punctuation">{</span> signature<span class="token punctuation">,</span> timestamp<span class="token punctuation">,</span> nonce<span class="token punctuation">,</span> echostr <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">;</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span> token <span class="token punctuation">}</span> <span class="token operator">=</span> config<span class="token punctuation">;</span>

  <span class="token comment">// 1. 判断消息是否来自微信</span>
  <span class="token keyword">const</span> sha1Str <span class="token operator">=</span> <span class="token function">sha1</span><span class="token punctuation">(</span><span class="token punctuation">[</span>timestamp<span class="token punctuation">,</span> nonce<span class="token punctuation">,</span> token<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>sha1Str <span class="token operator">!==</span> signature<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 消息不是来自于微信</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Error!!!!!'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 2. 接收请求体中的数据，流式数据</span>
  <span class="token keyword">const</span> xmlData <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getUserDataAsync</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>xmlData<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/*
    &lt;xml&gt;
      &lt;ToUserName&gt;&lt;![CDATA[gh_1a3680a1f984]]&gt;&lt;/ToUserName&gt; // 开发者id
      &lt;FromUserName&gt;&lt;![CDATA[ojKF_6lcSp8cLByurJlNJElwjCjg]]&gt;&lt;/FromUserName&gt; // 用户openid
      &lt;CreateTime&gt;1618305924&lt;/CreateTime&gt; // 发送的时间戳
      &lt;MsgType&gt;&lt;![CDATA[text]]&gt;&lt;/MsgType&gt; // 发送的消息类型
      &lt;Content&gt;&lt;![CDATA[123]]&gt;&lt;/Content&gt; // 发送的内容
      &lt;MsgId&gt;23168573006236500&lt;/MsgId&gt; // 消息id 微信服务器会默认保存3天用户发送的数据，通过此id三天内就能找到消息数据，三天后就被销毁
    &lt;/xml&gt;
  */</span>

  <span class="token comment">// 3. 将xml数据解析为js对象</span>
  <span class="token keyword">const</span> jsData <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">parseXMLAsync</span><span class="token punctuation">(</span>xmlData<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>jsData<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/*
    { xml:
      { ToUserName: [ 'gh_1a3680a1f984' ],
        FromUserName: [ 'ojKF_6lcSp8cLByurJlNJElwjCjg' ],
        CreateTime: [ '1618306482' ],
        MsgType: [ 'text' ],
        Content: [ '123' ],
        MsgId: [ '23168577811529715' ] } }
  */</span>

  <span class="token comment">// 4. 格式化数据</span>
  <span class="token keyword">const</span> message <span class="token operator">=</span> <span class="token function">formatMessage</span><span class="token punctuation">(</span>jsData<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/*
    { ToUserName: 'gh_1a3680a1f984',
      FromUserName: 'ojKF_6lcSp8cLByurJlNJElwjCjg',
      CreateTime: '1618312309',
      MsgType: 'text',
      Content: '123',
      MsgId: '23168664007830650' }
  */</span>

  <span class="token comment">// 5. 简单的自动回复</span>
  <span class="token comment">/*
    一旦遇到以下情况，微信都会在公众号会话中，向用户下发系统提示“该公众号暂时无法提供服务，请稍后再试”：
        1、开发者在5秒内未回复任何内容 
        2、开发者回复了异常数据，比如JSON数据，字符串，xml数据中有多余的空格等

    另外，请注意，回复图片（不支持gif动图）等多媒体消息时需要预先通过素材管理接口上传临时素材到微信服务器，
        可以使用素材管理中的临时素材，也可以使用永久素材。
  */</span>
  <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token function">reply</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> replyMessage <span class="token operator">=</span> <span class="token function">template</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 返回响应给微信服务器</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>replyMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// // 如果开发者服务器没有返回响应给微信服务器，微信服务器会发送三次请求过来</span>
  <span class="token comment">// res.end('');</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>开发者服务器自定义回复内容<code>/wechat/template.js</code></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/*
    处理用户发送的消息类型和内容，决定返回不同的内容给用户

    接收普通消息：https://developers.weixin.qq.com/doc/offiaccount/Message_Management/Receiving_standard_messages.html
    接收事件推送：https://developers.weixin.qq.com/doc/offiaccount/Message_Management/Receiving_event_pushes.html
*/</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">message</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>

    <span class="token keyword">let</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>
        toUserName<span class="token operator">:</span> message<span class="token punctuation">.</span>FromUserName<span class="token punctuation">,</span>
        fromUserName<span class="token operator">:</span> message<span class="token punctuation">.</span>ToUserName<span class="token punctuation">,</span>
        createTime<span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        msgType<span class="token operator">:</span> <span class="token string">'text'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">let</span> content <span class="token operator">=</span> <span class="token string">'暗号不对奥～'</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>MsgType <span class="token operator">===</span> <span class="token string">'text'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>Content <span class="token operator">===</span> <span class="token string">'1'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 全匹配</span>
            content <span class="token operator">=</span> <span class="token string">'你发个1给我干啥子？'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>Content <span class="token operator">===</span> <span class="token string">'2'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            content <span class="token operator">=</span> <span class="token string">'你发个2给我干啥子？'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>Content<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token string">'爱'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 半匹配</span>
            content <span class="token operator">=</span> <span class="token string">'我爱你～'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>MsgType <span class="token operator">===</span> <span class="token string">'image'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 用户发送图片消息</span>
        options<span class="token punctuation">.</span>msgType <span class="token operator">=</span> <span class="token string">'image'</span><span class="token punctuation">;</span>
        options<span class="token punctuation">.</span>mediaId <span class="token operator">=</span> message<span class="token punctuation">.</span>MediaId<span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span>PicUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>MsgType <span class="token operator">===</span> <span class="token string">'voice'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 用户发送语音消息</span>
        options<span class="token punctuation">.</span>msgType <span class="token operator">=</span> <span class="token string">'voice'</span><span class="token punctuation">;</span>
        options<span class="token punctuation">.</span>mediaId <span class="token operator">=</span> message<span class="token punctuation">.</span>MediaId<span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span>Recognition<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 需要“开启语音识别结果”，在“测试号管理”--&gt;“接口权限标表”</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>MsgType <span class="token operator">===</span> <span class="token string">'location'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        content <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">纬度:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>message<span class="token punctuation">.</span>Location_X<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 经度:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>message<span class="token punctuation">.</span>Location_Y<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 缩放大小:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>message<span class="token punctuation">.</span>Scale<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 位置信息:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>message<span class="token punctuation">.</span>Label<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>MsgType <span class="token operator">===</span> <span class="token string">'event'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>Event <span class="token operator">===</span> <span class="token string">'subscribe'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 用户订阅事件</span>
            content <span class="token operator">=</span> <span class="token string">'终于等到你啦，么么哒～'</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>EventKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                content <span class="token operator">=</span> <span class="token string">'用户扫描带参数的二维码关注事件'</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>Event <span class="token operator">===</span> <span class="token string">'unsubscribe'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'用户取关了～'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>Event <span class="token operator">===</span> <span class="token string">'SCAN'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            content <span class="token operator">=</span> <span class="token string">'用户已经关注过，再扫描带参数的二维码事件'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>Event <span class="token operator">===</span> <span class="token string">'LOCATION'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            content <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">纬度:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>message<span class="token punctuation">.</span>Latitude<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 经度:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>message<span class="token punctuation">.</span>Longitude<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 精度:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>message<span class="token punctuation">.</span>Precision<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>Event <span class="token operator">===</span> <span class="token string">'CLICK'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            content <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">您点击了按钮:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>message<span class="token punctuation">.</span>EventKey<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    options<span class="token punctuation">.</span>content <span class="token operator">=</span> content<span class="token punctuation">;</span>
    <span class="token keyword">return</span> options<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>开发者服务器组织回复xml模版<code>/wechat/template.js</code></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/*
    用来加工处理最终回复用户消息的模版（xml数据）
    文档：https://developers.weixin.qq.com/doc/offiaccount/Message_Management/Passive_user_reply_message.html
*/</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">options</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>

    <span class="token keyword">let</span> replyMessage <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;xml&gt;
        &lt;ToUserName&gt;&lt;![CDATA[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>options<span class="token punctuation">.</span>toUserName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">]]&gt;&lt;/ToUserName&gt;
        &lt;FromUserName&gt;&lt;![CDATA[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>options<span class="token punctuation">.</span>fromUserName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">]]&gt;&lt;/FromUserName&gt;
        &lt;CreateTime&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>options<span class="token punctuation">.</span>createTime<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/CreateTime&gt;
        &lt;MsgType&gt;&lt;![CDATA[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>options<span class="token punctuation">.</span>msgType<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">]]&gt;&lt;/MsgType&gt;</span><span class="token template-punctuation string">`</span></span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>msgType <span class="token operator">===</span> <span class="token string">'text'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        replyMessage <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;Content&gt;&lt;![CDATA[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>options<span class="token punctuation">.</span>content<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">]]&gt;&lt;/Content&gt;</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>msgType <span class="token operator">===</span> <span class="token string">'image'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        replyMessage <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;Image&gt;&lt;MediaId&gt;&lt;![CDATA[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>options<span class="token punctuation">.</span>mediaId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">]]&gt;&lt;/MediaId&gt;&lt;/Image&gt;</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>msgType <span class="token operator">===</span> <span class="token string">'voice'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        replyMessage <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;Voice&gt;&lt;MediaId&gt;&lt;![CDATA[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>options<span class="token punctuation">.</span>mediaId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">]]&gt;&lt;/MediaId&gt;&lt;/Voice&gt;</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>msgType <span class="token operator">===</span> <span class="token string">'video'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        replyMessage <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;Video&gt;
                &lt;MediaId&gt;&lt;![CDATA[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>options<span class="token punctuation">.</span>mediaId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">]]&gt;&lt;/MediaId&gt;
                &lt;Title&gt;&lt;![CDATA[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>options<span class="token punctuation">.</span>title<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">]]&gt;&lt;/Title&gt;
                &lt;Description&gt;&lt;![CDATA[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>options<span class="token punctuation">.</span>description<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">]]&gt;&lt;/Description&gt;
            &lt;/Video&gt;</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>msgType <span class="token operator">===</span> <span class="token string">'music'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        replyMessage <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;Music&gt;
                &lt;Title&gt;&lt;![CDATA[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>options<span class="token punctuation">.</span>title<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">]]&gt;&lt;/Title&gt;
                &lt;Description&gt;&lt;![CDATA[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>options<span class="token punctuation">.</span>description<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">]]&gt;&lt;/Description&gt;
                &lt;MusicUrl&gt;&lt;![CDATA[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>options<span class="token punctuation">.</span>musicUrl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">]]&gt;&lt;/MusicUrl&gt;
                &lt;HQMusicUrl&gt;&lt;![CDATA[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>options<span class="token punctuation">.</span>hqMusicUrl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">]]&gt;&lt;/HQMusicUrl&gt;
                &lt;ThumbMediaId&gt;&lt;![CDATA[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>options<span class="token punctuation">.</span>mediaId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">]]&gt;&lt;/ThumbMediaId&gt;
            &lt;/Music&gt;</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>msgType <span class="token operator">===</span> <span class="token string">'news'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        replyMessage <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;ArticleCount&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>options<span class="token punctuation">.</span>content<span class="token punctuation">.</span>length<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/ArticleCount&gt;
            &lt;Articles&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

            options<span class="token punctuation">.</span>content<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                replyMessage <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;item&gt;
                        &lt;Title&gt;&lt;![CDATA[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>item<span class="token punctuation">.</span>title<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">]]&gt;&lt;/Title&gt;
                        &lt;Description&gt;&lt;![CDATA[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>item<span class="token punctuation">.</span>description<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">]]&gt;&lt;/Description&gt;
                        &lt;PicUrl&gt;&lt;![CDATA[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>item<span class="token punctuation">.</span>picUrl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">]]&gt;&lt;/PicUrl&gt;
                        &lt;Url&gt;&lt;![CDATA[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>item<span class="token punctuation">.</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">]]&gt;&lt;/Url&gt;
                    &lt;/item&gt;</span><span class="token template-punctuation string">`</span></span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            replyMessage <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;/Articles&gt;</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">}</span>
    replyMessage <span class="token operator">+=</span> <span class="token string">'&lt;/xml&gt;'</span>
    <span class="token comment">// 最终回复给用户的xml数据</span>
    <span class="token keyword">return</span> replyMessage<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>通过测试号发送不同的消息，开发者服务器会自动回复
<br><img src="http://funky_hs.gitee.io/imgcloud/funkyblog/web/wx/wxpublic2/28.jpeg" width="300"></li></ul> <h2 id="_7-创建-删除自定义菜单"><a href="#_7-创建-删除自定义菜单" class="header-anchor">#</a> 7. 创建/删除自定义菜单</h2> <ul><li><p><a href="https://developers.weixin.qq.com/doc/offiaccount/Custom_Menus/Creating_Custom-Defined_Menu.html" target="_blank" rel="noopener noreferrer">创建自定义菜单<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p><a href="https://developers.weixin.qq.com/doc/offiaccount/Custom_Menus/Deleting_Custom-Defined_Menu.html" target="_blank" rel="noopener noreferrer">删除自定义菜单<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p>在<code>/wechat/menu.js</code>下创建菜单对象</p></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/*
    自定义菜单模块
    https://developers.weixin.qq.com/doc/offiaccount/Custom_Menus/Creating_Custom-Defined_Menu.html
*/</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;button&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span>
    <span class="token punctuation">{</span>	
        <span class="token string">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;点我啊&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;key&quot;</span><span class="token operator">:</span><span class="token string">&quot;CLICK&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        <span class="token string">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;菜单&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;sub_button&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span>
            <span class="token punctuation">{</span>	
              <span class="token string">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;view&quot;</span><span class="token punctuation">,</span>
              <span class="token string">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;跳转链接&quot;</span><span class="token punctuation">,</span>
              <span class="token string">&quot;url&quot;</span><span class="token operator">:</span><span class="token string">&quot;http://www.ahssty.com/&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token comment">// {</span>
            <span class="token comment">//     &quot;type&quot;:&quot;miniprogram&quot;,</span>
            <span class="token comment">//     &quot;name&quot;:&quot;跳转微信小程序&quot;,</span>
            <span class="token comment">//     &quot;url&quot;:&quot;http://mp.weixin.qq.com&quot;,</span>
            <span class="token comment">//     &quot;appid&quot;:&quot;wx286b93c14bbf93aa&quot;,</span>
            <span class="token comment">//     &quot;pagepath&quot;:&quot;pages/lunar/index&quot;</span>
            <span class="token comment">// },</span>
            <span class="token punctuation">{</span>
              <span class="token string">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span>
              <span class="token string">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;赞一下我&quot;</span><span class="token punctuation">,</span>
              <span class="token string">&quot;key&quot;</span><span class="token operator">:</span><span class="token string">&quot;V1001_GOOD&quot;</span>
           <span class="token punctuation">}</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>直接在<code>/wechat/wechat.js</code>中添加创建与删除自定义菜单的接口</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> menu <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./menu'</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Wechat</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token comment">// ...</span>
    <span class="token comment">// 省略了 fetchAccessToken() 方法的实现，在上面的步骤中</span>

    <span class="token comment">// 用来创建自定义菜单</span>
    <span class="token function">createMenu</span><span class="token punctuation">(</span><span class="token parameter">menu</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fetchAccessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://api.weixin.qq.com/cgi-bin/menu/create?access_token=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token punctuation">.</span>access_token<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
                <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> menu<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">resolve</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">&quot;createMenu方法出了问题：&quot;</span> <span class="token operator">+</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 用来删除自定义菜单</span>
    <span class="token function">deleteMenu</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fetchAccessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://api.weixin.qq.com/cgi-bin/menu/delete?access_token=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token punctuation">.</span>access_token<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
                <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">resolve</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">&quot;deleteMenu方法出了问题：&quot;</span> <span class="token operator">+</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 模拟测试</span>
<span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> w <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Wechat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 删除之前定义的菜单</span>
    <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token keyword">await</span> w<span class="token punctuation">.</span><span class="token function">deleteMenu</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
    result <span class="token operator">=</span> <span class="token keyword">await</span> w<span class="token punctuation">.</span><span class="token function">createMenu</span><span class="token punctuation">(</span>menu<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><ul><li>在命令行直接执行：<code>node wechat.js</code>，此时就可以在测试公众号看到自定义的菜单，如果没有看到，可以取关，重新关注
<br><img src="http://funky_hs.gitee.io/imgcloud/funkyblog/web/wx/wxpublic2/29.png" width="300"></li></ul> <h2 id="_8-微信网页开发"><a href="#_8-微信网页开发" class="header-anchor">#</a> 8. 微信网页开发</h2> <ul><li><a href="https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/JS-SDK.html#62" target="_blank" rel="noopener noreferrer">JS-SDK使用权限签名算法<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <h3 id="获取jsapi-ticket"><a href="#获取jsapi-ticket" class="header-anchor">#</a> 获取<code>jsapi_ticket</code></h3> <ul><li>在<code>/wechat/tool.js</code>中添加保存文件，读取文件的方法</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span>writeFile<span class="token punctuation">,</span> readFile<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span> <span class="token comment">// 引入fs模块</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>resolve<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span> <span class="token comment">// 使用绝对路径，这样保存的文件就都在当前目录下了</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// .... 省略其他方法</span>

    <span class="token comment">// 写文件保存到本地</span>
    <span class="token function">writeFileAsync</span> <span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span>fileName</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        data <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
        <span class="token keyword">const</span> filePath <span class="token operator">=</span> <span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span>fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">reslove<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">writeFile</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> data<span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>fileName<span class="token operator">+</span><span class="token string">'文件保存成功'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">reslove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">&quot;writeFileAsync方法出了问题：&quot;</span> <span class="token operator">+</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 读取本地文件数据</span>
    <span class="token function">readFileAsync</span><span class="token punctuation">(</span><span class="token parameter">fileName</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> filePath <span class="token operator">=</span> <span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span>fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">reslove<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">readFile</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span>data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>fileName <span class="token operator">+</span> <span class="token string">'文件读取成功'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    data <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
                    <span class="token function">reslove</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">&quot;readAccessToken方法出了问题：&quot;</span> <span class="token operator">+</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>在<code>/wechat/wechat.js</code>中编写获取<code>jsapi_ticket</code>代码</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> axios <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'axios'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> api <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./api'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> writeFileAsync<span class="token punctuation">,</span> readFileAsync<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./tool'</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Wechat</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token comment">//...省略了其他方法</span>

    <span class="token comment">// 用来获取 jsapi_ticket</span>
    <span class="token keyword">async</span> <span class="token function">getTicket</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fetchAccessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>api<span class="token punctuation">.</span>ticket<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;access_token=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token punctuation">.</span>access_token<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
        <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
            ticket<span class="token operator">:</span>res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ticket<span class="token punctuation">,</span> 
            expires_in<span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>expires_in <span class="token operator">-</span> <span class="token number">300</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 用来保存jsapi_ticket</span>
    <span class="token function">saveTicket</span><span class="token punctuation">(</span><span class="token parameter">ticket</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">writeFileAsync</span><span class="token punctuation">(</span>ticket<span class="token punctuation">,</span><span class="token string">'ticket.txt'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 用来读取jsapi_ticket</span>
    <span class="token function">readTicket</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">readFileAsync</span><span class="token punctuation">(</span><span class="token string">'ticket.txt'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 用来检测jsapi_ticket是否有效</span>
    <span class="token function">isValidTicket</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 检测传入的参数是否是有效的</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>data <span class="token operator">||</span> <span class="token operator">!</span>data<span class="token punctuation">.</span>ticket <span class="token operator">||</span> <span class="token operator">!</span>data<span class="token punctuation">.</span>expires_in<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 检测access_token是否在有效期内</span>
        <span class="token keyword">return</span> data<span class="token punctuation">.</span>expires_in <span class="token operator">&gt;</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 用来获取没有过期的jsapi_ticket</span>
    <span class="token function">fetchTicket</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ticket <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ticket_expires_in <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isValidTicket</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 说明之前保存过ticket，并且它是有效的，直接使用</span>
            <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                ticket<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ticket<span class="token punctuation">,</span>
                expires_in<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>expires_in
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">readTicket</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token comment">// 本地有文件,判断ticket是否过期</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isValidTicket</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 过期了,重新获取ticket</span>
                    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getTicket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">saveTicket</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
                    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token comment">// 本地没有文件</span>
                <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getTicket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">saveTicket</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
                <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token comment">// 将ticket挂载到this上</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>ticket <span class="token operator">=</span> res<span class="token punctuation">.</span>ticket<span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>ticket_expires_in <span class="token operator">=</span> res<span class="token punctuation">.</span>expires_in<span class="token punctuation">;</span>
                <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 模拟测试--获取jsapi_ticket</span>
<span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> w <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Wechat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token keyword">await</span> w<span class="token punctuation">.</span><span class="token function">fetchTicket</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><ul><li>测试结果</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># Funky @ hushengdeMacBook-Pro in ~ [17:44:36]</span>
$ node /Users/Funky/Desktop/wx/my-server/wechat/wechat.js
<span class="token punctuation">{</span> access_token:
   <span class="token string">'44_IImmQummxgCWJ1NKVm5tlkn_zmXrB1seeKRmLAbgmmuwnQLeIpq7xXrTVE-e-WP7n_U6KeOJl0ffhfNKn9I7Qpe44S2ebcPHzSxrCPU3z__DFCU9d2mP8w4vAXGGKFOTSqsv19tS5c6gH-CqKUEfACANXH'</span>,
  expires_in: <span class="token number">7200</span> <span class="token punctuation">}</span>
accessToken.txt文件保存成功
ticket.txt文件保存成功
<span class="token punctuation">{</span> ticket:
   <span class="token string">'O3SMpm8bG7kJnF36aXbe8y2JJi0B4sEzu_PHZGcOlW4FMCnxXIx_hUk3WgHEU8GQAuknFPwBuMNxw7XQTvOJ8g'</span>,
  expires_in: <span class="token number">1618400383827</span> <span class="token punctuation">}</span>
</code></pre></div><h3 id="使用js-api方法"><a href="#使用js-api方法" class="header-anchor">#</a> 使用JS-API方法</h3> <ul><li>开发者服务器生成前端页面使用JS-API所需要的配置信息，在<code>/wechat/wechat.js</code>中</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 生成前端页面使用JS-API所需要的配置信息</span>
<span class="token keyword">async</span> <span class="token function">getSignConfig</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/*
        1，参与签名的字段包括noncestr（随机字符串）, 有效的jsapi_ticket, timestamp（时间戳）, url（当前网页的URL，不包含#及其后面部分） 。
        2，对所有待签名参数按照字段名的ASCII 码从小到大排序（字典序）后，
        3，使用URL键值对的格式（即key1 = value1 &amp; key2=value2…）拼接成字符串string1。这里需要注意的是所有参数名均为小写字符。
        4，对string1作sha1加密，字段名和字段值都采用原始值，不进行URL 转义。
    */</span>
    <span class="token keyword">const</span> noncestr <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">36</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> timestamp <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>ticket<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fetchTicket</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">var</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">jsapi_ticket:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ticket<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">noncestr:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>noncestr<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">timestamp:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>timestamp<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">url=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">]</span>
    <span class="token keyword">const</span> str <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'&amp;'</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> signature <span class="token operator">=</span> <span class="token function">sha1</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//生成签名</span>
    <span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
        signature<span class="token punctuation">,</span>
        noncestr<span class="token punctuation">,</span>
        timestamp<span class="token punctuation">,</span>
        url<span class="token punctuation">,</span>
        appId<span class="token operator">:</span> appID
    <span class="token punctuation">}</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;------------signObj = \n&quot;</span><span class="token punctuation">,</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> obj<span class="token punctuation">;</span>            
<span class="token punctuation">}</span>
</code></pre></div><ul><li>在<code>/routes/index.js</code>中写前端调用的接口</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 可以获取到wxconfig参数</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/wxconfig'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> url <span class="token operator">=</span> <span class="token function">decodeURIComponent</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> w <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Wechat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> conf <span class="token operator">=</span> <span class="token keyword">await</span> w<span class="token punctuation">.</span><span class="token function">getSignConfig</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
  <span class="token comment">// let conf = await sign(url);</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'conf'</span><span class="token punctuation">,</span> conf<span class="token punctuation">)</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><ul><li>在<code>search.html</code>中使用
<ul><li><ol><li>绑定域名 -- 在测试号页面上行填写js安全域名接口
<br><img src="http://funky_hs.gitee.io/imgcloud/funkyblog/web/wx/wxpublic2/30.png" width="400"></li></ol></li> <li><ol start="2"><li>引入js文件  <code>&lt;script src=&quot;http://res.wx.qq.com/open/js/jweixin-1.6.0.js&quot;&gt;&lt;/script&gt;</code></li></ol></li> <li><ol start="3"><li>通过config接口注入权限验证配置</li></ol></li> <li><a href="https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/JS-SDK.html#63" target="_blank" rel="noopener noreferrer">所有js接口列表<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li></ul> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Express<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>stylesheet<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/stylesheets/style.css<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://res.wx.qq.com/open/js/jweixin-1.6.0.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>https://cdn.bootcss.com/axios/0.19.2/axios.min.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>https://cdn.bootcss.com/vue/2.6.11/vue.min.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>app<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>这是Search页面<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>scanCode<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>扫描二维码<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    el<span class="token operator">:</span><span class="token string">'#app'</span><span class="token punctuation">,</span>
    <span class="token function">mounted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">wxconfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    methods<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token function">wxconfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">let</span> url <span class="token operator">=</span> <span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>location<span class="token punctuation">.</span>href<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'#'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment">// http://localhost:3000/wxconfig</span>
        axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">http://4741b3b0bb43.ngrok.io/wxconfig?url=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">result</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
          <span class="token keyword">let</span> <span class="token punctuation">{</span>appId<span class="token punctuation">,</span>timestamp<span class="token punctuation">,</span>noncestr<span class="token punctuation">,</span>signature<span class="token punctuation">}</span> <span class="token operator">=</span> result<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'jsapi接口下发的数据'</span><span class="token punctuation">,</span>result<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
          wx<span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            debug<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。</span>
            <span class="token operator">...</span>result<span class="token punctuation">.</span>data<span class="token punctuation">,</span>
            <span class="token comment">// appId, // 必填，公众号的唯一标识</span>
            <span class="token comment">// timestamp, // 必填，生成签名的时间戳</span>
            <span class="token comment">// nonceStr, // 必填，生成签名的随机串</span>
            <span class="token comment">// signature,// 必填，签名</span>
            jsApiList<span class="token operator">:</span> <span class="token punctuation">[</span>
              <span class="token string">'onMenuShareWeibo'</span><span class="token punctuation">,</span>
              <span class="token string">'startRecord'</span><span class="token punctuation">,</span>
              <span class="token string">'stopRecord'</span><span class="token punctuation">,</span>
              <span class="token string">'translateVoice'</span><span class="token punctuation">,</span>
              <span class="token string">'scanQRCode'</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 必填，需要使用的JS接口列表</span>

          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// 微信sdk验证成功的函数回调</span>
          wx<span class="token punctuation">.</span><span class="token function">ready</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">// config信息验证后会执行ready方法，所有接口调用都必须在config接口获得结果之后，config是一个客户端的异步操作，所以如果需要在页面加载时就调用相关接口，则须把相关接口放在ready函数中调用来确保正确执行。对于用户触发时才调用的接口，则可以直接调用，不需要放在ready函数中。</span>

            <span class="token comment">// 判断当前客户端版本是否支持指定JS接口</span>
            wx<span class="token punctuation">.</span><span class="token function">checkJsApi</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                jsApiList<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'chooseImage'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 需要检测的JS接口列表，所有JS接口列表见附录2,</span>
                <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 以键值对的形式返回，可用的api值true，不可用为false</span>
                    <span class="token comment">// 如：{&quot;checkResult&quot;:{&quot;chooseImage&quot;:true},&quot;errMsg&quot;:&quot;checkJsApi:ok&quot;}</span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// 微信sdk验证失败的函数回调</span>
          wx<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">// config信息验证失败会执行error函数，如签名过期导致验证失败，具体错误信息可以打开config的debug模式查看，也可以在返回的res参数中查看，对于SPA可以在这里更新签名。</span>

          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function">scanCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        wx<span class="token punctuation">.</span><span class="token function">scanQRCode</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          needResult<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// 默认为0，扫描结果由微信处理，1则直接返回扫描结果，</span>
          scanType<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;qrCode&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;barCode&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 可以指定扫二维码还是一维码，默认二者都有</span>
          <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">var</span> result <span class="token operator">=</span> res<span class="token punctuation">.</span>resultStr<span class="token punctuation">;</span> <span class="token comment">// 当needResult 为 1 时，扫码返回的结果</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><br><img src="http://funky_hs.gitee.io/imgcloud/funkyblog/web/wx/wxpublic2/31.png" width="700"></p> <h2 id="参考"><a href="#参考" class="header-anchor">#</a> 参考</h2> <ul><li><a href="https://www.bilibili.com/video/BV1KD4y1d7zD" target="_blank" rel="noopener noreferrer">2020微信公众号开发（零基础全面系统教程）<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://www.bilibili.com/video/BV1nb411P7c9" target="_blank" rel="noopener noreferrer">微信公众号开发实战<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <h2 id="源码"><a href="#源码" class="header-anchor">#</a> 源码</h2> <ul><li><a href="https://github.com/funkyHS/wxpublic" target="_blank" rel="noopener noreferrer">源码<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/funkyblog/web/wxpublic/wxpublic1/" class="prev">
        1. 微信订阅号一
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/funkyblog/assets/js/app.a24b3efd.js" defer></script><script src="/funkyblog/assets/js/2.3aea1f50.js" defer></script><script src="/funkyblog/assets/js/127.d14ed3d3.js" defer></script>
  </body>
</html>
